<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DC_Volley - Digital Scoresheet</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#1a1a2e;overflow:hidden;height:100vh}
.app{display:flex;flex-direction:column;height:100vh}
.setup-screen{padding:40px;max-width:900px;margin:0 auto;overflow-y:auto;height:100vh;background:#0f3460}
.setup-card{background:#16213e;padding:30px;border-radius:10px;margin-bottom:20px;border:3px solid #533483}
.setup-title{color:#e94560;margin-bottom:20px;font-size:24px;text-align:center}
.form-group{margin-bottom:15px}
.form-label{display:block;color:#fff;font-weight:bold;margin-bottom:5px;font-size:13px}
.form-input,.form-select{width:100%;padding:10px;border:2px solid #533483;border-radius:5px;font-size:13px;background:#0f3460;color:#fff}
.roster-table{width:100%;color:#fff;font-size:12px;border-collapse:collapse}
.roster-table thead tr{background:#533483}
.roster-table th{padding:8px;text-align:center;font-weight:bold}
.roster-table td{padding:8px}
.roster-input{width:100%;padding:6px;border:2px solid #533483;border-radius:3px;font-size:12px;background:#1a1a2e;color:#fff;text-align:center}
.roster-input:focus{outline:none;border-color:#00d9ff;background:#16213e}
.roster-input.name-input{text-align:left}
.roster-select{width:100%;padding:6px 8px;border:2px solid #533483;border-radius:3px;font-size:12px;background:#1a1a2e;color:#fff;min-width:100px}
.roster-select:focus{outline:none;border-color:#00d9ff;background:#16213e}
.btn-confirm{background:#00d9ff;color:#000;width:100%;padding:15px;border:none;border-radius:5px;font-size:16px;cursor:pointer;font-weight:bold;margin-top:20px}
.btn-confirm:hover{opacity:0.9}
.btn-cancel{background:#666;color:#fff;padding:12px;border:none;border-radius:5px;font-size:14px;cursor:pointer;font-weight:bold}
.hidden{display:none}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:1000;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:#16213e;padding:25px;border-radius:10px;max-width:900px;width:95%;max-height:90vh;overflow-y:auto;border:3px solid #533483}
.modal-title{color:#e94560;margin-bottom:20px;font-size:22px;text-align:center}
.lineup-setup{display:flex;gap:15px;margin:15px 0}
.team-setup{flex:1;background:#0f3460;padding:12px;border-radius:8px;border:2px solid #533483}
.team-setup h3{color:#e94560;margin-bottom:10px;text-align:center;font-size:16px}
.player-roster{background:#1a1a2e;padding:8px;border-radius:6px;margin-bottom:10px;max-height:200px;overflow-y:auto}
.roster-player{padding:6px 8px;margin-bottom:4px;background:#16213e;border-radius:4px;color:#fff;font-size:11px;cursor:pointer;border:2px solid transparent;transition:0.2s}
.roster-player:hover{border-color:#00d9ff;background:#0f3460}
.roster-player.selected{background:#533483;border-color:#e94560}
.court-setup{background:#c67c3a;border:3px solid #fff;border-radius:8px;padding:10px;margin-top:8px}
.court-setup-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.court-setup-pos{background:#d9984f;border:2px solid #fff;border-radius:5px;padding:10px 6px;text-align:center;min-height:60px;display:flex;flex-direction:column;justify-content:center;cursor:pointer;position:relative}
.court-setup-pos:hover{background:#e0a668}
.court-setup-pos.filled{background:#ffeb3b;border-color:#ffc107}
.pos-setup-label{font-size:10px;font-weight:bold;color:#fff;background:rgba(0,0,0,0.4);padding:2px 4px;border-radius:3px;margin-bottom:4px}
.pos-setup-num{font-size:26px;font-weight:bold;color:#000}
.pos-setup-name{display:none}
.modal-buttons{display:flex;gap:10px;margin-top:20px}
.top-bar{background:#0f3460;padding:8px 20px;display:flex;justify-content:space-between;align-items:center;color:#fff;border-bottom:3px solid #16213e}
.top-bar h1{font-size:18px;color:#e94560}
.match-info{font-size:12px;color:#ccc}
.btn-small{padding:6px 12px;border:none;border-radius:4px;font-size:11px;cursor:pointer;font-weight:bold;background:#e94560;color:#fff;margin-left:5px}
.btn-export{background:#00d9ff;color:#000}
.btn-lineup{background:#9c27b0;color:#fff}
.btn-scoreboard{background:#ffc107;color:#000}
.main{display:flex;flex:1;overflow:hidden;background:#0f3460}
.side-panel{width:180px;background:#16213e;border-right:2px solid #0f3460;overflow-y:auto;padding:10px}
.side-title{color:#e94560;font-size:13px;font-weight:bold;margin-bottom:10px;padding:8px;background:#0f3460;border-radius:4px;text-align:center}
.lineup-list{background:#1a1a2e;border-radius:4px;padding:8px}
.lineup-item{padding:6px;margin-bottom:5px;background:#0f3460;border-radius:3px;font-size:11px;color:#fff;display:flex;align-items:center;justify-content:space-between}
.lineup-pos{color:#e94560;font-weight:bold;min-width:30px;font-size:13px}
.lineup-badge{padding:2px 5px;border-radius:2px;font-size:9px;font-weight:bold;margin-left:4px}
.badge-c{background:#ffd700;color:#000}
.badge-l{background:#9c27b0;color:#fff}
.on-court{color:#00ff00;font-size:14px}
.center{flex:1;display:flex;flex-direction:column}
.score-section{background:#16213e;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid #0f3460}
.team-score{text-align:center;flex:1}
.team-name{font-size:22px;font-weight:bold;margin-bottom:5px}
.score-display{font-size:70px;font-weight:bold;line-height:1;font-family:monospace}
.team-a{color:#ff6b6b}
.team-b{color:#4ecdc4}
.set-center{text-align:center;padding:12px;background:#533483;color:#fff}
.set-title{font-size:16px;margin-bottom:8px}
.set-dots{display:flex;gap:10px;justify-content:center}
.set-dot{width:32px;height:32px;border-radius:50%;border:2px solid #fff;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:bold;background:#1a1a2e}
.set-won-a{background:#ff6b6b;border-color:#ff6b6b}
.set-won-b{background:#4ecdc4;border-color:#4ecdc4}
.courts{display:flex;flex:1;background:#0f3460}
.court-container{flex:1;display:flex;flex-direction:column;padding:12px;border-right:1px solid #16213e}
.court-container:last-child{border-right:none}
.court-header{background:#16213e;padding:10px;border-radius:6px;margin-bottom:10px}
.court-name{color:#e94560;font-size:15px;font-weight:bold;text-align:center;margin-bottom:8px}
.stats-row{display:flex;justify-content:space-around;margin-top:8px}
.stat{text-align:center}
.stat-label{font-size:9px;color:#888;display:block}
.stat-val{font-size:14px;color:#fff;font-weight:bold;display:block}
.court-visual{background:#c67c3a;border:3px solid #fff;border-radius:8px;padding:12px;margin-bottom:10px;flex:1;display:flex;align-items:center;justify-content:center}
.court-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;width:100%;max-width:350px}
.court-pos{background:#d9984f;border:2px solid #fff;border-radius:5px;padding:12px 8px;text-align:center;min-height:75px;display:flex;flex-direction:column;justify-content:center;position:relative;cursor:pointer;transition:0.2s}
.court-pos:hover{background:#e0a668;transform:scale(1.02)}
.pos-label{font-size:10px;font-weight:bold;color:#fff;background:rgba(0,0,0,0.4);padding:2px 5px;border-radius:3px;margin-bottom:4px}
.pos-player{display:none}
.pos-jersey{font-size:24px;color:#000;font-weight:bold}
.libero-on-court{background:#9c27b0 !important;border-color:#9c27b0 !important;box-shadow:0 0 20px rgba(156,39,176,0.9)}
.libero-on-court .pos-jersey{color:#fff}
.libero-on-court .pos-label{background:rgba(255,255,255,0.3)}
.server{background:#ffeb3b;box-shadow:0 0 20px rgba(255,235,59,0.9);border-width:3px;border-color:#ffc107}
.server::before{content:'üèê';position:absolute;top:-14px;right:-14px;background:linear-gradient(135deg, #ffeb3b 0%, #00d9ff 100%);color:#000;padding:5px 8px;border-radius:50%;font-size:15px;border:2px solid #fff;z-index:10}
.copyright-footer{background:#0f3460;padding:10px 20px;text-align:center;color:#888;font-size:11px;border-top:2px solid #16213e}
.copyright-footer a{color:#00d9ff;text-decoration:none}
.copyright-footer a:hover{text-decoration:underline}
.controls{padding:10px;background:#16213e}
.btn-group{display:flex;gap:8px;margin-bottom:8px}
.btn{padding:12px;border:none;border-radius:5px;font-size:13px;font-weight:bold;cursor:pointer;transition:0.2s;flex:1;text-align:center}
.btn:hover{opacity:0.9;transform:translateY(-1px)}
.btn-point{background:#00d9ff;color:#000;font-size:18px;padding:16px}
.btn-timeout{background:#ff9500;color:#fff;font-size:11px}
.btn-sub{background:#007aff;color:#fff;font-size:11px}
.btn-rotate{background:#af52de;color:#fff;font-size:11px}
.timeout-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:2000;align-items:center;justify-content:center}
.timeout-modal.active{display:flex}
.timeout-content{background:#16213e;padding:40px;border-radius:15px;text-align:center;border:4px solid #ff9500;min-width:500px}
.timeout-timer{font-size:120px;font-weight:bold;color:#ff9500;font-family:monospace;line-height:1;margin:20px 0}
.timeout-team{font-size:28px;color:#fff;margin-bottom:20px}
.timeout-score{font-size:32px;color:#fff;margin-top:20px;background:#0f3460;padding:20px;border-radius:10px;border:3px solid #533483}
.timeout-score-label{font-size:16px;color:#888;margin-bottom:10px}
.timeout-score-display{display:flex;justify-content:center;align-items:center;gap:30px;margin-top:10px}
.timeout-team-score{display:flex;flex-direction:column;align-items:center;gap:8px}
.timeout-team-score-name{font-size:18px;font-weight:bold}
.timeout-team-score-points{font-size:48px;font-weight:bold;font-family:monospace}
.sub-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:2000;align-items:center;justify-content:center}
.sub-modal.active{display:flex}
.sub-content{background:#16213e;padding:30px;border-radius:10px;border:3px solid #007aff;max-width:800px;width:90%;max-height:90vh;overflow-y:auto}
.sub-title{color:#007aff;font-size:24px;margin-bottom:20px;text-align:center}
.sub-section{margin-bottom:25px}
.sub-section h4{color:#e94560;margin-bottom:10px;font-size:16px}
.player-select-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px}
.player-select-btn{padding:12px;background:#0f3460;border:2px solid #533483;border-radius:5px;color:#fff;cursor:pointer;transition:0.2s;text-align:left}
.player-select-btn:hover{background:#16213e;border-color:#00d9ff}
.player-select-btn.selected{background:#007aff;border-color:#007aff}
.player-select-btn.disabled{opacity:0.4;cursor:not-allowed}
.sub-info{background:#0f3460;padding:15px;border-radius:5px;color:#ffd700;font-size:14px;margin-bottom:20px}
.libero-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:2000;align-items:center;justify-content:center}
.libero-modal.active{display:flex}
.libero-content{background:#16213e;padding:30px;border-radius:10px;border:3px solid #9c27b0;max-width:700px;width:90%;max-height:90vh;overflow-y:auto}
.libero-title{color:#9c27b0;font-size:24px;margin-bottom:20px;text-align:center}
.libero-section{margin-bottom:20px}
.libero-section h4{color:#e94560;margin-bottom:10px;font-size:16px}
.libero-info{background:#0f3460;padding:12px;border-radius:5px;color:#ffd700;font-size:13px;margin-bottom:15px}
.libero-select-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
.libero-player-btn{padding:12px;background:#0f3460;border:2px solid #533483;border-radius:5px;color:#fff;cursor:pointer;transition:0.2s;text-align:left;font-size:13px}
.libero-player-btn:hover{background:#16213e;border-color:#9c27b0}
.libero-player-btn.selected{background:#9c27b0;border-color:#9c27b0}
.libero-player-btn.libero{border-color:#9c27b0;background:#1a1a2e}
.libero-badge-big{background:#9c27b0;color:#fff;padding:3px 8px;border-radius:3px;font-size:10px;font-weight:bold;margin-left:5px}
.btn-libero{background:#9c27b0;color:#fff;font-size:11px}
.history-item{background:#1a1a2e;padding:12px;margin-bottom:8px;border-radius:5px;border-left:4px solid}
.history-item.timeout-item{border-color:#ff9500}
.history-item.sub-item{border-color:#007aff}
.history-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.history-team{font-weight:bold;color:#fff;font-size:14px}
.history-set{color:#888;font-size:11px}
.history-score-box{background:#16213e;padding:8px;border-radius:4px;margin-top:8px}
.history-score-display{display:flex;justify-content:space-around;align-items:center}
.history-team-score{text-align:center}
.history-team-name{font-size:10px;color:#888}
.history-points{font-size:20px;font-weight:bold;color:#fff}
.history-sub-info{font-size:12px;color:#ccc;margin-top:6px}
.history-sub-arrow{color:#00d9ff;margin:0 5px}
.history-empty{text-align:center;color:#888;padding:20px;font-size:13px}

</style>
</head>
<body>
<div class="app">
<div id="setupScreen" class="setup-screen">
<div class="setup-card">
<h2 class="setup-title">Match Information</h2>
<div class="form-group"><label class="form-label">Date</label><input class="form-input" type="date" id="matchDate"></div>
<div class="form-group"><label class="form-label">Time</label><input class="form-input" type="time" id="matchTime"></div>
<div class="form-group"><label class="form-label">Competition</label><input class="form-input" id="comp" value="FIVB Championship 2026"></div>
<div class="form-group"><label class="form-label">Match Number</label><input class="form-input" id="matchNo" value="M-001"></div>
<div class="form-group"><label class="form-label">Venue</label><input class="form-input" id="venue" value="National Stadium"></div>
<div class="form-group"><label class="form-label">Format</label><select class="form-select" id="fmt"><option value="3">Best of 3</option><option value="5">Best of 5</option></select></div>
</div>

<div class="setup-card">
<h2 class="setup-title">Match Officials</h2>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
<div class="form-group"><label class="form-label">1st Referee</label><input class="form-input" id="ref1" placeholder="Name"></div>
<div class="form-group"><label class="form-label">2nd Referee</label><input class="form-input" id="ref2" placeholder="Name"></div>
<div class="form-group"><label class="form-label">Scorer</label><input class="form-input" id="scorer" placeholder="Name"></div>
<div class="form-group"><label class="form-label">Assistant Scorer</label><input class="form-input" id="assistScorer" placeholder="Name"></div>
</div>
</div>

<div class="setup-card">
<h2 class="setup-title">Team Setup</h2>
<p style="color:#00d9ff;font-size:13px;margin-bottom:15px">üìù First, enter both teams. After coin toss, you'll assign which team goes on which side (A or B)</p>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
<div>
<div class="form-group"><label class="form-label">Team 1 Name</label><input class="form-input" id="team1Name" value="Warriors"></div>
<div class="form-group">
<label class="form-label">Team 1 Jersey Color</label>
<div style="display:flex;gap:10px;align-items:center">
<input type="color" id="team1Color" value="#ff6b6b" style="width:60px;height:40px;border:none;border-radius:5px;cursor:pointer">
<span style="color:#fff;font-size:12px">Jersey color</span>
</div>
</div>
</div>
<div>
<div class="form-group"><label class="form-label">Team 2 Name</label><input class="form-input" id="team2Name" value="Eagles"></div>
<div class="form-group">
<label class="form-label">Team 2 Jersey Color</label>
<div style="display:flex;gap:10px;align-items:center">
<input type="color" id="team2Color" value="#4ecdc4" style="width:60px;height:40px;border:none;border-radius:5px;cursor:pointer">
<span style="color:#fff;font-size:12px">Jersey color</span>
</div>
</div>
</div>
</div>
</div>

<div class="setup-card">
<h2 class="setup-title">Coin Toss</h2>
<div class="form-group">
<label class="form-label">Coin Toss Winner</label>
<select class="form-select" id="coinTossWinner">
<option value="">-- Select Winner --</option>
<option value="team1">Team 1</option>
<option value="team2">Team 2</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Winner's Choice</label>
<select class="form-select" id="coinTossChoice">
<option value="">-- Select Choice --</option>
<option value="serve">Serve First</option>
<option value="receive">Receive First</option>
<option value="side">Choose Side</option>
</select>
</div>

<div id="teamAssignment" style="background:#0f3460;padding:20px;border-radius:8px;margin-top:20px;display:none">
<h3 style="color:#ffd700;margin-bottom:15px;font-size:16px">üìã Assign Team Positions</h3>
<p style="color:#fff;font-size:13px;margin-bottom:15px">Choose which team will be Team A (left side) or Team B (right side):</p>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
<div>
<label class="form-label" style="color:#ff6b6b">Team A (Left Side)</label>
<select class="form-select" id="teamAAssignment">
<option value="">-- Select Team --</option>
<option value="team1">Team 1</option>
<option value="team2">Team 2</option>
</select>
</div>
<div>
<label class="form-label" style="color:#4ecdc4">Team B (Right Side)</label>
<select class="form-select" id="teamBAssignment">
<option value="">-- Select Team --</option>
<option value="team1">Team 1</option>
<option value="team2">Team 2</option>
</select>
</div>
</div>
<p style="color:#ffa500;font-size:12px;margin-top:15px">‚ö†Ô∏è Make sure each team is assigned to a different side!</p>
</div>

<div id="coinTossResult" style="background:#0f3460;padding:15px;border-radius:5px;margin-top:15px;display:none">
<div style="color:#00d9ff;font-weight:bold;font-size:14px;margin-bottom:10px">‚úì Coin Toss Result:</div>
<div style="color:#fff;font-size:13px;line-height:1.8">
<div>üéØ <strong>First Server:</strong> <span id="firstServer"></span></div>
<div>üî• <strong>First Receiver:</strong> <span id="firstReceiver"></span></div>
<div>üìç <strong>Court Sides:</strong> <span id="courtSides"></span></div>
</div>
</div>
</div>

<div class="setup-card">
<h2 class="setup-title">Team Rosters</h2>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
<div>
<h3 style="margin-bottom:15px;text-align:center" id="team1Header"><span style="color:#ff6b6b">TEAM 1</span> - <span id="team1Count">0</span>/14 Players</h3>
<div style="background:#0f3460;padding:15px;border-radius:8px;overflow-y:auto;max-height:500px">
<table class="roster-table">
<thead style="position:sticky;top:0;background:#533483;z-index:10">
<tr>
<th style="width:10%">N</th>
<th style="width:15%">Jersey</th>
<th style="width:48%;text-align:left">Player Name</th>
<th style="width:27%">Role</th>
</tr>
</thead>
<tbody id="rosterInput1"></tbody>
</table>
</div>
</div>
<div>
<h3 style="margin-bottom:15px;text-align:center" id="team2Header"><span style="color:#4ecdc4">TEAM 2</span> - <span id="team2Count">0</span>/14 Players</h3>
<div style="background:#0f3460;padding:15px;border-radius:8px;overflow-y:auto;max-height:500px">
<table class="roster-table">
<thead style="position:sticky;top:0;background:#533483;z-index:10">
<tr>
<th style="width:10%">N</th>
<th style="width:15%">Jersey</th>
<th style="width:48%;text-align:left">Player Name</th>
<th style="width:27%">Role</th>
</tr>
</thead>
<tbody id="rosterInput2"></tbody>
</table>
</div>
</div>
</div>
<div style="display:flex;gap:15px;align-items:center">
<button class="btn-small" onclick="openOfficialsModal()" style="background:#ff69b4;color:#000;padding:12px 24px">üë• Team Officials & Signatures</button>
<button class="btn-confirm" id="nextLineupBtn" style="flex:1">Next: Setup Lineups ‚Üí</button>
</div>
</div>
<div style="text-align:center;padding:15px;color:#666;font-size:11px;background:#0f3460;border-top:2px solid #16213e;margin-top:20px">
  DC_Volley ¬© 2025 | Digital Volleyball Scoresheet
</div>
</div>

<div id="lineupModal" class="modal">
<div class="modal-content">
<h3 class="modal-title">Select Starting Lineups for Set 1</h3>
<div class="lineup-setup">
<div class="team-setup">
<h3 style="color:#ff6b6b">TEAM A - <span id="teamANameSetup"></span></h3>
<div class="player-roster" id="rosterASetup"></div>
<div class="court-setup">
<div class="court-setup-grid" id="courtASetup">
<div class="court-setup-pos" data-pos="4"><span class="pos-setup-label">P4-LF</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="3"><span class="pos-setup-label">P3-MF</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="2"><span class="pos-setup-label">P2-RF</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="5"><span class="pos-setup-label">P5-LB</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="6"><span class="pos-setup-label">P6-MB</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="1"><span class="pos-setup-label">P1-RB</span><div class="pos-setup-num">-</div></div>
</div>
</div>
</div>
<div class="team-setup">
<h3 style="color:#4ecdc4">TEAM B - <span id="teamBNameSetup"></span></h3>
<div class="player-roster" id="rosterBSetup"></div>
<div class="court-setup">
<div class="court-setup-grid" id="courtBSetup">
<div class="court-setup-pos" data-pos="4"><span class="pos-setup-label">P4-LF</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="3"><span class="pos-setup-label">P3-MF</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="2"><span class="pos-setup-label">P2-RF</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="5"><span class="pos-setup-label">P5-LB</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="6"><span class="pos-setup-label">P6-MB</span><div class="pos-setup-num">-</div></div>
<div class="court-setup-pos" data-pos="1"><span class="pos-setup-label">P1-RB</span><div class="pos-setup-num">-</div></div>
</div>
</div>
</div>
</div>
<p style="color:#ffd700;text-align:center;font-size:12px;margin-top:15px">Click on a player, then click on a court position to assign</p>
<div class="modal-buttons">
<button class="btn-cancel" onclick="cancelLineup()" style="flex:1">Cancel</button>
<button class="btn-confirm" id="startMatchBtn" style="flex:1">Start Match</button>
</div>
</div>
</div>

<div id="matchScreen" class="hidden">
<div class="top-bar">
<h1>üèê DC_Volley</h1>
<div class="match-info">
<span id="topInfo"></span> | 
<span style="color:#00ff00">‚è± Match: <span id="matchDuration">00:00:00</span></span> | 
<span style="color:#ffeb3b">Set: <span id="setDuration">00:00</span></span>
</div>
<div>
<button class="btn-small" onclick="openMatchDataModal()" style="background:#00ff00;color:#000">üíæ DATA</button>
<button class="btn-small" onclick="openSummaryModal()" style="background:#ffd700;color:#000">üìä SUMMARY</button>
<button class="btn-small" onclick="openHistoryModal()" style="background:#00d9ff;color:#000">üìã HISTORY</button>
<button class="btn-small btn-export" onclick="exportToPDF()">üìÑ Export PDF</button>
<button class="btn-small btn-lineup" onclick="openLineupDisplay()">üë• Lineup</button>
<button class="btn-small btn-scoreboard" onclick="openScoreboard()">üì∫ Scoreboard</button>
<button class="btn-small" onclick="openOfficialsModal()" style="background:#ff69b4;color:#000">üë• OFFICIALS</button>
<button class="btn-small" onclick="openSanctionModal()" style="background:#ff0000;color:#fff">‚ö†Ô∏è SANCTION</button>
<button class="btn-small" onclick="swapSides()">üîÑ SWAP</button>
<button class="btn-small" onclick="undoPoint()" style="background:#ff9500">‚Ü∂ UNDO</button>
<button class="btn-small" onclick="endMatch()">End Match</button>
<button class="btn-small" onclick="confirm('Exit?')&&location.reload()">Exit</button>
</div>
</div>

<div class="main">
<div class="side-panel">
<div class="side-title" id="sideATtl">TEAM A LINEUP</div>
<div class="lineup-list" id="lineupA"></div>
</div>

<div class="center">
<div class="score-section">
<div class="team-score">
<div class="team-name team-a" id="nameDispA">TEAM A</div>
<div class="score-display team-a" id="scoreDispA">0</div>
<div style="color:#888;font-size:11px">Sets: <span id="setsA">0</span></div>
</div>
<div class="set-center">
<div class="set-title">SET <span id="setDisp">1</span></div>
<div class="set-dots" id="setDotsDisp"></div>
<div style="font-size:11px;margin-top:5px" id="setTypeDisp"></div>
</div>
<div class="team-score">
<div class="team-name team-b" id="nameDispB">TEAM B</div>
<div class="score-display team-b" id="scoreDispB">0</div>
<div style="color:#888;font-size:11px">Sets: <span id="setsB">0</span></div>
</div>
</div>

<div class="courts">
<div class="court-container">
<div class="court-header">
<div class="court-name" id="courtNameA">TEAM A</div>
<div class="stats-row">
<div class="stat"><span class="stat-label">TIMEOUT</span><span class="stat-val" id="toDispA">0/2</span></div>
<div class="stat"><span class="stat-label">SUB</span><span class="stat-val" id="subDispA">0/6</span></div>
<div class="stat"><span class="stat-label">SERVE</span><span class="stat-val" id="servDispA">YES</span></div>
</div>
</div>
<div class="court-visual">
<div class="court-grid" id="courtGridA">
<div class="court-pos" data-pos="4"><span class="pos-label">P4-LF</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="3"><span class="pos-label">P3-MF</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="2"><span class="pos-label">P2-RF</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="5"><span class="pos-label">P5-LB</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="6"><span class="pos-label">P6-MB</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="1"><span class="pos-label">P1-RB</span><div class="pos-player">-</div></div>
</div>
</div>
<div class="controls">
<div class="btn-group"><button class="btn btn-point" onclick="addPoint('A')">+ POINT</button></div>
<div class="btn-group">
<button class="btn btn-timeout" onclick="takeTimeout('A')">‚è± TO</button>
<button class="btn btn-sub" onclick="openSubModal('A')">üë• SUB</button>
</div>
<div class="btn-group">
<button class="btn btn-libero" onclick="openLiberoModal('A')">üîÑ LIBERO</button>
<button class="btn btn-rotate" onclick="manualRotate('A')">üîÑ ROT</button>
</div>
</div>
</div>

<div class="court-container">
<div class="court-header">
<div class="court-name" id="courtNameB">TEAM B</div>
<div class="stats-row">
<div class="stat"><span class="stat-label">TIMEOUT</span><span class="stat-val" id="toDispB">0/2</span></div>
<div class="stat"><span class="stat-label">SUB</span><span class="stat-val" id="subDispB">0/6</span></div>
<div class="stat"><span class="stat-label">SERVE</span><span class="stat-val" id="servDispB">NO</span></div>
</div>
</div>
<div class="court-visual">
<div class="court-grid" id="courtGridB">
<div class="court-pos" data-pos="4"><span class="pos-label">P4-LF</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="3"><span class="pos-label">P3-MF</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="2"><span class="pos-label">P2-RF</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="5"><span class="pos-label">P5-LB</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="6"><span class="pos-label">P6-MB</span><div class="pos-player">-</div></div>
<div class="court-pos" data-pos="1"><span class="pos-label">P1-RB</span><div class="pos-player">-</div></div>
</div>
</div>
<div class="controls">
<div class="btn-group"><button class="btn btn-point" onclick="addPoint('B')">+ POINT</button></div>
<div class="btn-group">
<button class="btn btn-timeout" onclick="takeTimeout('B')">‚è± TO</button>
<button class="btn btn-sub" onclick="openSubModal('B')">üë• SUB</button>
</div>
<div class="btn-group">
<button class="btn btn-libero" onclick="openLiberoModal('B')">üîÑ LIBERO</button>
<button class="btn btn-rotate" onclick="manualRotate('B')">üîÑ ROT</button>
</div>
</div>
</div>
</div>
</div>

<div class="side-panel">
<div class="side-title" id="sideBTtl">TEAM B LINEUP</div>
<div class="lineup-list" id="lineupB"></div>
</div>
</div>

<div class="copyright-footer">
  <div>DC_Volley ¬© 2025 | Digital Volleyball Scoresheet</div>
</div>
</div>

<div id="timeoutModal" class="timeout-modal">
<div class="timeout-content">
<div class="timeout-team" id="timeoutTeamName">TIMEOUT</div>
<div class="timeout-timer" id="timeoutTimer">30</div>
<div class="timeout-score">
<div class="timeout-score-label">SCORE AT TIMEOUT</div>
<div class="timeout-score-display" id="timeoutScoreDisplay">
<div class="timeout-team-score">
<div class="timeout-team-score-name" id="timeoutTeamAName">Team A</div>
<div class="timeout-team-score-points team-a" id="timeoutTeamAScore">0</div>
</div>
<div style="font-size:40px;color:#888">-</div>
<div class="timeout-team-score">
<div class="timeout-team-score-name" id="timeoutTeamBName">Team B</div>
<div class="timeout-team-score-points team-b" id="timeoutTeamBScore">0</div>
</div>
</div>
</div>
<button class="btn-confirm" onclick="endTimeout()" style="margin-top:30px">End Timeout</button>
</div>
</div>

<div id="subModal" class="sub-modal">
<div class="sub-content">
<h3 class="sub-title">Substitution - <span id="subTeamName"></span></h3>
<div class="sub-info" id="subInfo">Select a player OUT, then select a player IN</div>
<div class="sub-section">
<h4>Players ON Court (Select player to come OUT)</h4>
<div class="player-select-grid" id="playersOut"></div>
</div>
<div class="sub-section">
<h4>Players on Bench (Select player to come IN)</h4>
<div class="player-select-grid" id="playersIn"></div>
</div>
<div class="modal-buttons">
<button class="btn-cancel" onclick="closeSubModal()">Cancel</button>
<button class="btn-confirm" id="confirmSubBtn" onclick="confirmSubstitution()">Confirm Substitution</button>
</div>
</div>
</div>

<div id="liberoModal" class="libero-modal">
<div class="libero-content">
<h3 class="libero-title">Libero Replacement - <span id="liberoTeamName"></span></h3>
<div class="libero-info" id="liberoInfo">Select a back-row player to replace with Libero</div>
<div class="libero-section">
<h4>Available Liberos</h4>
<div class="libero-select-grid" id="liberosList"></div>
</div>
<div class="libero-section">
<h4>Back Row Players (Can be replaced by Libero)</h4>
<div class="libero-select-grid" id="backRowPlayers"></div>
</div>
<div class="modal-buttons">
<button class="btn-cancel" onclick="closeLiberoModal()">Cancel</button>
<button class="btn-confirm" id="confirmLiberoBtn" onclick="confirmLiberoReplacement()">Confirm Replacement</button>
</div>
</div>
</div>

<div id="historyModal" class="modal">
<div class="modal-content" style="max-width:1200px;max-height:90vh">
<h3 class="modal-title">üìã MATCH HISTORY</h3>

<div id="historyContent" style="max-height:70vh;overflow-y:auto;padding:10px"></div>

<div class="modal-buttons">
<button class="btn-confirm" style="background:#00ff00;color:#000" onclick="exportHistoryPDF()">üì• Export PDF</button>
<button class="btn-confirm" onclick="closeHistoryModal()">Close</button>
</div>
</div>
</div>

<div id="summaryModal" class="modal">
<div class="modal-content" style="max-width:1400px;max-height:90vh;overflow-y:auto">
<h3 class="modal-title">üìä MATCH SUMMARY</h3>
<p style="color:#00d9ff;font-size:13px;margin-bottom:15px">Complete match statistics and event log</p>

<!-- Statistics Overview -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px">
<div style="background:#0f3460;padding:15px;border-radius:8px;border:2px solid #ffd700">
<h4 style="color:#ffd700;font-size:14px;margin-bottom:8px">‚è± TIMEOUTS USED</h4>
<div id="summaryTimeouts" style="color:#fff;font-size:13px">
<div><span id="teamATimeouts">0</span> / 2</div>
<div><span id="teamBTimeouts">0</span> / 2</div>
</div>
</div>

<div style="background:#0f3460;padding:15px;border-radius:8px;border:2px solid #00d9ff">
<h4 style="color:#00d9ff;font-size:14px;margin-bottom:8px">üë• SUBSTITUTIONS</h4>
<div id="summarySubstitutions" style="color:#fff;font-size:13px">
<div><span id="teamASubstitutions">0</span> / 6</div>
<div><span id="teamBSubstitutions">0</span> / 6</div>
</div>
</div>

<div style="background:#0f3460;padding:15px;border-radius:8px;border:2px solid #ff6b6b">
<h4 style="color:#ff6b6b;font-size:14px;margin-bottom:8px">‚ö†Ô∏è SANCTIONS</h4>
<div id="summarySanctions" style="color:#fff;font-size:13px">
<div><span id="teamASanctions">0</span></div>
<div><span id="teamBSanctions">0</span></div>
</div>
</div>

<div style="background:#0f3460;padding:15px;border-radius:8px;border:2px solid #4ecdc4">
<h4 style="color:#4ecdc4;font-size:14px;margin-bottom:8px">‚è∞ MATCH DURATION</h4>
<div id="summaryDuration" style="color:#fff;font-size:13px">
<div id="totalDuration">--:--:--</div>
</div>
</div>
</div>

<!-- Set-by-Set Breakdown -->
<div id="setBreakdownContainer" style="margin-bottom:20px"></div>

<!-- Event Log -->
<div style="background:#0f3460;padding:15px;border-radius:8px">
<h4 style="color:#ffd700;margin-bottom:10px;font-size:16px">üìã Event Log</h4>
<div style="max-height:400px;overflow-y:auto">
<table style="width:100%;border-collapse:collapse;color:#fff;font-size:13px">
<thead style="position:sticky;top:0;background:#533483;z-index:10">
<tr>
<th style="padding:10px;text-align:left;border-bottom:2px solid #00d9ff">Set</th>
<th style="padding:10px;text-align:left;border-bottom:2px solid #00d9ff">Time</th>
<th style="padding:10px;text-align:left;border-bottom:2px solid #00d9ff">Team</th>
<th style="padding:10px;text-align:left;border-bottom:2px solid #00d9ff">Event</th>
<th style="padding:10px;text-align:left;border-bottom:2px solid #00d9ff">Details</th>
</tr>
</thead>
<tbody id="summaryTableBody">
<tr>
<td colspan="5" style="padding:20px;text-align:center;color:#888">No events yet. Start the match to see live updates.</td>
</tr>
</tbody>
</table>
</div>
</div>

<div class="modal-buttons">
<button class="btn-confirm" style="background:#00ff00;color:#000" onclick="exportSummaryPDF()">üì• Export PDF</button>
<button class="btn-confirm" onclick="closeSummaryModal()">Close</button>
</div>
</div>
</div>

<div id="officialsModal" class="modal">
<div class="modal-content" style="max-width:800px;max-height:85vh;overflow-y:auto">
<h3 class="modal-title">üë• TEAM OFFICIALS & SIGNATURES</h3>
<p style="color:#00d9ff;font-size:13px;margin-bottom:15px">Team staff information and captain/coach signatures</p>

<!-- Team A Officials -->
<div style="background:#0f3460;padding:20px;border-radius:8px;border:2px solid #ff6b6b;margin-bottom:15px">
<h4 style="color:#ff6b6b;margin-bottom:15px;font-size:18px;text-align:center">
  <span style="font-size:14px;opacity:0.8">TEAM A:</span> <span id="officialsTeamATitle" style="font-weight:bold">TEAM A</span>
</h4>

<div style="margin-bottom:15px;background:#16213e;padding:12px;border-radius:5px;border:2px solid #ff6b6b">
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px;font-weight:bold">‚úèÔ∏è Team Name</label>
<input type="text" id="teamANameInput" class="form-input" placeholder="Enter Team A name" style="background:#0f3460;border:1px solid #ff6b6b;color:#fff;padding:10px;width:100%;border-radius:5px;font-size:14px;font-weight:bold">
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:15px">
<div>
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px">Coach Name</label>
<input type="text" id="coachA" class="form-input" placeholder="Coach name" style="background:#16213e;border:1px solid #533483;color:#fff;padding:8px;width:100%;border-radius:5px">
</div>

<div>
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px">Assistant Coach</label>
<input type="text" id="asstCoachA" class="form-input" placeholder="Assistant coach name" style="background:#16213e;border:1px solid #533483;color:#fff;padding:8px;width:100%;border-radius:5px">
</div>

<div>
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px">Medical Officer</label>
<input type="text" id="medicalA" class="form-input" placeholder="Medical officer name" style="background:#16213e;border:1px solid #533483;color:#fff;padding:8px;width:100%;border-radius:5px">
</div>

<div>
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px">Trainer</label>
<input type="text" id="trainerA" class="form-input" placeholder="Trainer name" style="background:#16213e;border:1px solid #533483;color:#fff;padding:8px;width:100%;border-radius:5px">
</div>
</div>

<div style="border-top:2px solid #533483;padding-top:15px">
<h5 style="color:#ffd700;margin-bottom:10px;font-size:14px">‚úçÔ∏è Signatures</h5>

<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
<div>
<label style="color:#fff;font-size:11px;display:block;margin-bottom:5px;text-align:center">Captain (Before)</label>
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#16213e;display:flex;align-items:center;justify-content:center">
<canvas id="captainSignA1" width="200" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
<button onclick="clearSignature('captainSignA1')" style="background:#ff6b6b;color:#fff;border:none;padding:3px 6px;border-radius:3px;font-size:9px;margin-top:4px;cursor:pointer;width:100%">Clear</button>
</div>

<div>
<label style="color:#fff;font-size:11px;display:block;margin-bottom:5px;text-align:center">Captain (After)</label>
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#16213e;display:flex;align-items:center;justify-content:center">
<canvas id="captainSignA2" width="200" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
<button onclick="clearSignature('captainSignA2')" style="background:#ff6b6b;color:#fff;border:none;padding:3px 6px;border-radius:3px;font-size:9px;margin-top:4px;cursor:pointer;width:100%">Clear</button>
</div>

<div>
<label style="color:#fff;font-size:11px;display:block;margin-bottom:5px;text-align:center">Coach Signature</label>
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#16213e;display:flex;align-items:center;justify-content:center">
<canvas id="coachSignA" width="200" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
<button onclick="clearSignature('coachSignA')" style="background:#ff6b6b;color:#fff;border:none;padding:3px 6px;border-radius:3px;font-size:9px;margin-top:4px;cursor:pointer;width:100%">Clear</button>
</div>
</div>
</div>
</div>

<!-- Team B Officials -->
<div style="background:#0f3460;padding:20px;border-radius:8px;border:2px solid #4ecdc4;margin-bottom:15px">
<h4 style="color:#4ecdc4;margin-bottom:15px;font-size:18px;text-align:center">
  <span style="font-size:14px;opacity:0.8">TEAM B:</span> <span id="officialsTeamBTitle" style="font-weight:bold">TEAM B</span>
</h4>

<div style="margin-bottom:15px;background:#16213e;padding:12px;border-radius:5px;border:2px solid #4ecdc4">
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px;font-weight:bold">‚úèÔ∏è Team Name</label>
<input type="text" id="teamBNameInput" class="form-input" placeholder="Enter Team B name" style="background:#0f3460;border:1px solid #4ecdc4;color:#fff;padding:10px;width:100%;border-radius:5px;font-size:14px;font-weight:bold">
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:15px">
<div>
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px">Coach Name</label>
<input type="text" id="coachB" class="form-input" placeholder="Coach name" style="background:#16213e;border:1px solid #533483;color:#fff;padding:8px;width:100%;border-radius:5px">
</div>

<div>
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px">Assistant Coach</label>
<input type="text" id="asstCoachB" class="form-input" placeholder="Assistant coach name" style="background:#16213e;border:1px solid #533483;color:#fff;padding:8px;width:100%;border-radius:5px">
</div>

<div>
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px">Medical Officer</label>
<input type="text" id="medicalB" class="form-input" placeholder="Medical officer name" style="background:#16213e;border:1px solid #533483;color:#fff;padding:8px;width:100%;border-radius:5px">
</div>

<div>
<label style="color:#00d9ff;font-size:12px;display:block;margin-bottom:5px">Trainer</label>
<input type="text" id="trainerB" class="form-input" placeholder="Trainer name" style="background:#16213e;border:1px solid #533483;color:#fff;padding:8px;width:100%;border-radius:5px">
</div>
</div>

<div style="border-top:2px solid #533483;padding-top:15px">
<h5 style="color:#ffd700;margin-bottom:10px;font-size:14px">‚úçÔ∏è Signatures</h5>

<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
<div>
<label style="color:#fff;font-size:11px;display:block;margin-bottom:5px;text-align:center">Captain (Before)</label>
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#16213e;display:flex;align-items:center;justify-content:center">
<canvas id="captainSignB1" width="200" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
<button onclick="clearSignature('captainSignB1')" style="background:#4ecdc4;color:#000;border:none;padding:3px 6px;border-radius:3px;font-size:9px;margin-top:4px;cursor:pointer;width:100%">Clear</button>
</div>

<div>
<label style="color:#fff;font-size:11px;display:block;margin-bottom:5px;text-align:center">Captain (After)</label>
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#16213e;display:flex;align-items:center;justify-content:center">
<canvas id="captainSignB2" width="200" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
<button onclick="clearSignature('captainSignB2')" style="background:#4ecdc4;color:#000;border:none;padding:3px 6px;border-radius:3px;font-size:9px;margin-top:4px;cursor:pointer;width:100%">Clear</button>
</div>

<div>
<label style="color:#fff;font-size:11px;display:block;margin-bottom:5px;text-align:center">Coach Signature</label>
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#16213e;display:flex;align-items:center;justify-content:center">
<canvas id="coachSignB" width="200" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
<button onclick="clearSignature('coachSignB')" style="background:#4ecdc4;color:#000;border:none;padding:3px 6px;border-radius:3px;font-size:9px;margin-top:4px;cursor:pointer;width:100%">Clear</button>
</div>
</div>
</div>
</div>

<!-- Match Officials Signatures - Each on separate row -->
<div style="background:#0f3460;padding:15px;border-radius:8px;border:2px solid #ffc107;margin-bottom:15px">
<h4 style="color:#ffc107;margin-bottom:12px;font-size:16px;text-align:center">‚öñÔ∏è MATCH OFFICIALS SIGNATURES</h4>

<!-- 1st Referee Row -->
<div style="background:#16213e;padding:12px;border-radius:5px;margin-bottom:10px;display:flex;align-items:center;gap:15px">
<div style="flex:1">
<div style="color:#00d9ff;font-size:11px;font-weight:bold;margin-bottom:3px">1st Referee</div>
<div style="color:#fff;font-size:13px" id="ref1Display">-</div>
</div>
<div style="flex:2">
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#0f3460;display:flex;align-items:center;justify-content:center">
<canvas id="firstRefSign" width="400" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
</div>
<button onclick="clearSignature('firstRefSign')" style="background:#ffc107;color:#000;border:none;padding:8px 16px;border-radius:3px;font-size:10px;cursor:pointer">Clear</button>
</div>

<!-- 2nd Referee Row -->
<div style="background:#16213e;padding:12px;border-radius:5px;margin-bottom:10px;display:flex;align-items:center;gap:15px">
<div style="flex:1">
<div style="color:#00d9ff;font-size:11px;font-weight:bold;margin-bottom:3px">2nd Referee</div>
<div style="color:#fff;font-size:13px" id="ref2Display">-</div>
</div>
<div style="flex:2">
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#0f3460;display:flex;align-items:center;justify-content:center">
<canvas id="secondRefSign" width="400" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
</div>
<button onclick="clearSignature('secondRefSign')" style="background:#ffc107;color:#000;border:none;padding:8px 16px;border-radius:3px;font-size:10px;cursor:pointer">Clear</button>
</div>

<!-- Scorer Row -->
<div style="background:#16213e;padding:12px;border-radius:5px;margin-bottom:10px;display:flex;align-items:center;gap:15px">
<div style="flex:1">
<div style="color:#00d9ff;font-size:11px;font-weight:bold;margin-bottom:3px">Scorer</div>
<div style="color:#fff;font-size:13px" id="scorerDisplay">-</div>
</div>
<div style="flex:2">
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#0f3460;display:flex;align-items:center;justify-content:center">
<canvas id="scorerSign" width="400" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
</div>
<button onclick="clearSignature('scorerSign')" style="background:#ffc107;color:#000;border:none;padding:8px 16px;border-radius:3px;font-size:10px;cursor:pointer">Clear</button>
</div>

<!-- Assistant Scorer Row -->
<div style="background:#16213e;padding:12px;border-radius:5px;display:flex;align-items:center;gap:15px">
<div style="flex:1">
<div style="color:#00d9ff;font-size:11px;font-weight:bold;margin-bottom:3px">Asst. Scorer</div>
<div style="color:#fff;font-size:13px" id="assistScorerDisplay">-</div>
</div>
<div style="flex:2">
<div style="border:2px dashed #533483;height:50px;border-radius:5px;background:#0f3460;display:flex;align-items:center;justify-content:center">
<canvas id="assistScorerSign" width="400" height="40" style="cursor:crosshair;display:block"></canvas>
</div>
</div>
<button onclick="clearSignature('assistScorerSign')" style="background:#ffc107;color:#000;border:none;padding:8px 16px;border-radius:3px;font-size:10px;cursor:pointer">Clear</button>
</div>
</div>

<div class="modal-buttons">
<button class="btn-confirm" onclick="saveOfficials()">üíæ Save</button>
<button class="btn-cancel" onclick="closeOfficialsModal()">Close</button>
</div>
</div>
</div>

<div id="sanctionModal" class="modal">
<div class="modal-content" style="max-width:600px">
<h3 class="modal-title">‚ö†Ô∏è SANCTION</h3>
<p style="color:#00d9ff;font-size:13px;margin-bottom:15px">Record penalties and sanctions</p>

<div style="background:#0f3460;padding:20px;border-radius:8px">
<div style="margin-bottom:20px">
<label style="color:#fff;font-size:14px;margin-bottom:10px;display:block">Select Team:</label>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
<button onclick="selectSanctionTeam('A')" id="sanctionTeamA" style="padding:15px;background:#16213e;border:2px solid #533483;color:#fff;border-radius:5px;cursor:pointer;font-size:14px">
<span id="sanctionTeamAName">Team A</span>
</button>
<button onclick="selectSanctionTeam('B')" id="sanctionTeamB" style="padding:15px;background:#16213e;border:2px solid #533483;color:#fff;border-radius:5px;cursor:pointer;font-size:14px">
<span id="sanctionTeamBName">Team B</span>
</button>
</div>
</div>

<div style="margin-bottom:20px">
<label style="color:#fff;font-size:14px;margin-bottom:10px;display:block">Sanction Type:</label>
<select id="sanctionType" class="form-select" style="background:#16213e;border:1px solid #533483;color:#fff;padding:10px;width:100%;border-radius:5px">
<option value="">-- Select Type --</option>
<option value="delay">Delay Warning</option>
<option value="delay_penalty">Delay Penalty</option>
<option value="misconduct_warning">Misconduct Warning (Yellow Card)</option>
<option value="misconduct_penalty">Misconduct Penalty (Red Card)</option>
<option value="misconduct_expulsion">Expulsion (Red + Yellow)</option>
<option value="misconduct_disqualification">Disqualification</option>
</select>
</div>

<div style="margin-bottom:20px">
<label style="color:#fff;font-size:14px;margin-bottom:10px;display:block">Player/Coach Jersey # (Optional):</label>
<input type="text" id="sanctionPlayer" placeholder="Enter jersey number or 'Coach'" class="form-input" style="background:#16213e;border:1px solid #533483;color:#fff;padding:10px;width:100%;border-radius:5px">
</div>

<div>
<label style="color:#fff;font-size:14px;margin-bottom:10px;display:block">Notes:</label>
<textarea id="sanctionNotes" placeholder="Additional details..." style="background:#16213e;border:1px solid #533483;color:#fff;padding:10px;width:100%;border-radius:5px;min-height:80px"></textarea>
</div>
</div>

<div class="modal-buttons">
<button class="btn-confirm" onclick="recordSanction()">Record Sanction</button>
<button class="btn-cancel" onclick="closeSanctionModal()">Cancel</button>
</div>
</div>
</div>

<div id="decidingSetTossModal" class="modal">
<div class="modal-content" style="max-width:600px">
<h3 class="modal-title">üéØ DECIDING SET COIN TOSS</h3>
<p style="color:#00d9ff;font-size:14px;margin-bottom:20px;text-align:center">
  Conduct coin toss to determine first service and court side
</p>

<div style="background:#0f3460;padding:25px;border-radius:8px;margin-bottom:20px">
<h4 style="color:#ffd700;margin-bottom:20px;font-size:18px;text-align:center">STEP 1: WHO WON THE TOSS?</h4>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
<button id="decidingTossA" onclick="decidingSetTossWinner('A')" style="padding:20px;background:#16213e;border:3px solid #533483;color:#ff6b6b;border-radius:8px;cursor:pointer;font-size:18px;font-weight:bold">
<span id="decidingTossAName">TEAM A</span>
</button>
<button id="decidingTossB" onclick="decidingSetTossWinner('B')" style="padding:20px;background:#16213e;border:3px solid #533483;color:#4ecdc4;border-radius:8px;cursor:pointer;font-size:18px;font-weight:bold">
<span id="decidingTossBName">TEAM B</span>
</button>
</div>
</div>

<div id="decidingTossChoice" style="display:none;background:#0f3460;padding:25px;border-radius:8px;margin-bottom:20px">
<h4 style="color:#ffd700;margin-bottom:20px;font-size:18px;text-align:center">
STEP 2: <span id="decidingTossWinnerName"></span> CHOOSES:
</h4>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
<button onclick="decidingSetTossChoice('serve')" style="padding:20px;background:#16213e;border:3px solid #533483;color:#fff;border-radius:8px;cursor:pointer;font-size:16px">
üèê SERVE FIRST
</button>
<button onclick="decidingSetTossChoice('receive')" style="padding:20px;background:#16213e;border:3px solid #533483;color:#fff;border-radius:8px;cursor:pointer;font-size:16px">
üì• RECEIVE FIRST
</button>
</div>
</div>

<div class="modal-buttons">
<button class="btn-cancel" onclick="closeDecidingSetTossModal()">Cancel</button>
</div>
</div>
</div>

<div id="matchDataModal" class="modal">
<div class="modal-content" style="max-width:1200px">
<h3 class="modal-title">üíæ MATCH DATA</h3>

<div style="background:#0f3460;padding:20px;border-radius:8px;margin-bottom:15px">
<h4 style="color:#00ff00;margin-bottom:15px;font-size:18px">Match Information</h4>
<div id="matchDataInfo" style="color:#fff;font-size:13px;line-height:1.8"></div>
</div>

<div style="display:flex;gap:15px;margin-bottom:15px">
<div style="flex:1;background:#0f3460;padding:15px;border-radius:8px">
<h4 style="color:#ff6b6b;margin-bottom:10px;font-size:16px">Team A</h4>
<div id="teamAData" style="color:#fff;font-size:12px"></div>
</div>
<div style="flex:1;background:#0f3460;padding:15px;border-radius:8px">
<h4 style="color:#4ecdc4;margin-bottom:10px;font-size:16px">Team B</h4>
<div id="teamBData" style="color:#fff;font-size:12px"></div>
</div>
</div>

<div style="background:#0f3460;padding:20px;border-radius:8px;margin-bottom:15px">
<h4 style="color:#ffd700;margin-bottom:15px;font-size:18px">Sets Data</h4>
<div id="setsData" style="max-height:400px;overflow-y:auto"></div>
</div>

<div class="modal-buttons">
<button class="btn-confirm" style="background:#00ff00;color:#000" onclick="downloadMatchDataPDF()">üì• Download PDF</button>
<button class="btn-confirm" onclick="closeMatchDataModal()">Close</button>
</div>
</div>
</div>

</div>

<script>
var gameData = {
  teams: {
    A: {players: [], lineup: []},
    B: {players: [], lineup: []}
  },
  matchInfo: {},
  coinToss: {winner: null, choice: null, firstServer: null},
  selectedPlayer: null,
  score: {A: 0, B: 0},
  sets: [],
  currentSet: 1,
  swapped: false,
  startTime: null,
  setStartTime: null,
  history: [],
  timeouts: {A: 0, B: 0},
  substitutions: {A: 0, B: 0},
  timeoutTimer: null,
  matchTimerInterval: null,
  timeoutRemaining: 0,
  currentTimeoutTeam: null,
  subSelection: {playerOut: null, playerIn: null, team: null},
  liberoSelection: {libero: null, playerOut: null, team: null},
  liberoReplacements: {A: [], B: []},
  actionHistory: [],
  substitutionTracking: {A: {}, B: {}},
  matchSummary: [],
  officials: null
};

function initRosterTables() {
  // Initialize with team1 and team2
  gameData.teams = {
    team1: {players: [], lineup: []},
    team2: {players: [], lineup: []}
  };
  
  createRosterRows('1');
  createRosterRows('2');
}

function createRosterRows(team) {
  var tbody = document.getElementById('rosterInput' + team);
  var html = '';
  
  for (var i = 1; i <= 14; i++) {
    html += '<tr style="background:#16213e">';
    html += '<td style="text-align:center;color:#888;font-weight:bold">' + i + '</td>';
    html += '<td><input type="text" class="roster-input" id="team' + team + '_jersey_' + i + '" maxlength="2" placeholder="#"></td>';
    html += '<td><input type="text" class="roster-input name-input" id="team' + team + '_name_' + i + '" placeholder="PLAYER NAME" style="text-transform:uppercase"></td>';
    html += '<td><select class="roster-select" id="team' + team + '_role_' + i + '">';
    html += '<option value="">-</option>';
    html += '<option value="player">Player</option>';
    html += '<option value="captain">Captain</option>';
    html += '<option value="libero1">Libero 1</option>';
    html += '<option value="libero2">Libero 2</option>';
    html += '</select></td>';
    html += '</tr>';
  }
  
  tbody.innerHTML = html;
  
  for (var i = 1; i <= 14; i++) {
    addRowListeners(team, i);
  }
}

function addRowListeners(team, row) {
  var jerseyInput = document.getElementById('team' + team + '_jersey_' + row);
  var nameInput = document.getElementById('team' + team + '_name_' + row);
  var roleInput = document.getElementById('team' + team + '_role_' + row);
  
  var updateFunction = function() {
    updatePlayerData(team, row);
  };
  
  // Use 'blur' for jersey (validates when done typing)
  jerseyInput.addEventListener('blur', function() {
    updatePlayerData(team, row);
  });
  
  // INSTANT duplicate check on every keystroke (no delay)
  jerseyInput.addEventListener('input', function() {
    var currentValue = jerseyInput.value.trim();
    // Only check if we have at least one digit
    if (currentValue.length >= 1) {
      // Instant check - no delay
      checkDuplicateJerseyInstant(team, row);
    }
  });
  
  // Keep 'input' for name (immediate feedback is fine for names)
  nameInput.addEventListener('input', updateFunction);
  
  // Special validation for role changes
  roleInput.addEventListener('change', function() {
    validateRoleSelection(team, row);
  });
}

function checkDuplicateJersey(team, row) {
  var teamKey = 'team' + team;
  var jerseyInput = document.getElementById(teamKey + '_jersey_' + row);
  var jersey = jerseyInput.value.trim();
  
  if (!jersey) return;
  
  var jerseyNum = parseInt(jersey);
  if (isNaN(jerseyNum)) return;
  
  // Get all OTHER players (exclude current row)
  var otherPlayers = gameData.teams[teamKey].players.filter(function(p) {
    return p.row !== row;
  });
  
  // Check for duplicate
  var duplicate = otherPlayers.find(function(p) {
    return parseInt(p.jersey) === jerseyNum;
  });
  
  if (duplicate) {
    // Show error and CLEAR the field
    alert('‚ùå DUPLICATE JERSEY NUMBER\n\nJersey #' + jerseyNum + ' is already used by:\n' + duplicate.name + ' (Row ' + (duplicate.row + 1) + ')\n\nEach player must have a unique jersey number.\n\nPlease choose a different number.');
    jerseyInput.value = '';
    jerseyInput.style.borderColor = '#ff0000';
    jerseyInput.style.borderWidth = '3px';
    jerseyInput.focus();
    // Remove the player data if it was saved
    gameData.teams[teamKey].players = gameData.teams[teamKey].players.filter(function(p) {
      return p.row !== row;
    });
    updateCount(team);
  } else {
    // Reset to normal
    jerseyInput.style.borderColor = '';
    jerseyInput.style.borderWidth = '';
  }
}

function checkDuplicateJerseyInstant(team, row) {
  var teamKey = 'team' + team;
  var jerseyInput = document.getElementById(teamKey + '_jersey_' + row);
  var jersey = jerseyInput.value.trim();
  
  if (!jersey) {
    jerseyInput.style.borderColor = '';
    jerseyInput.style.borderWidth = '';
    return;
  }
  
  var jerseyNum = parseInt(jersey);
  if (isNaN(jerseyNum)) return;
  
  // Check ALL fields in the table (not just saved data)
  var allJerseyFields = [];
  for (var i = 0; i < 14; i++) {
    var fieldId = teamKey + '_jersey_' + i;
    var field = document.getElementById(fieldId);
    if (field && i !== row) { // Skip current row
      var fieldValue = field.value.trim();
      if (fieldValue) {
        allJerseyFields.push({
          row: i,
          jersey: parseInt(fieldValue)
        });
      }
    }
  }
  
  // Check if current number already exists
  var duplicate = allJerseyFields.find(function(f) {
    return f.jersey === jerseyNum;
  });
  
  if (duplicate) {
    // Highlight in RED - duplicate detected
    jerseyInput.style.borderColor = '#ff0000';
    jerseyInput.style.borderWidth = '3px';
    jerseyInput.style.backgroundColor = '#ffcccc';
  } else {
    // Reset to normal - no duplicate
    jerseyInput.style.borderColor = '';
    jerseyInput.style.borderWidth = '';
    jerseyInput.style.backgroundColor = '';
  }
}

function validateRoleSelection(team, row) {
  var teamKey = 'team' + team;
  var roleInput = document.getElementById(teamKey + '_role_' + row);
  var selectedRole = roleInput.value;
  
  // Only validate special roles (captain, libero1, libero2)
  if (!selectedRole || selectedRole === 'player' || selectedRole === '') {
    updatePlayerData(team, row);
    return;
  }
  
  // Get current jersey for this row (may be empty)
  var currentJersey = document.getElementById(teamKey + '_jersey_' + row).value.trim();
  
  // Check if this role is already taken by another player (exclude current row)
  // Look at ALL rows, not just saved players
  var allRoleInputs = document.querySelectorAll('[id^="' + teamKey + '_role_"]');
  var conflictFound = false;
  var conflictJersey = '';
  var conflictName = '';
  
  allRoleInputs.forEach(function(input) {
    var inputRow = input.id.split('_')[2];
    if (inputRow !== String(row) && input.value === selectedRole) {
      conflictFound = true;
      conflictJersey = document.getElementById(teamKey + '_jersey_' + inputRow).value.trim();
      conflictName = document.getElementById(teamKey + '_name_' + inputRow).value.trim();
    }
  });
  
  var roleLabels = {
    'captain': 'Captain',
    'libero1': 'Libero 1',
    'libero2': 'Libero 2'
  };
  
  if (conflictFound) {
    var conflictInfo = conflictJersey && conflictName ? 
      '#' + conflictJersey + ' ' + conflictName : 
      'Row ' + (parseInt(row) + 1);
    
    alert('‚ùå Team already has ' + roleLabels[selectedRole] + '\n\n' + 
          conflictInfo + ' is already assigned as ' + roleLabels[selectedRole] + 
          '.\n\nOnly ONE ' + roleLabels[selectedRole] + ' allowed per team.');
    roleInput.value = '';
    return;
  }
  
  // Role is valid, proceed with normal update
  updatePlayerData(team, row);
}

function updatePlayerData(team, row) {
  var teamKey = 'team' + team;
  var jersey = document.getElementById(teamKey + '_jersey_' + row).value.trim();
  var name = document.getElementById(teamKey + '_name_' + row).value.trim().toUpperCase();
  var role = document.getElementById(teamKey + '_role_' + row).value;
  
  // Find existing player in this row (if updating)
  var existingPlayer = gameData.teams[teamKey].players.find(function(p) {
    return p.row === row;
  });
  
  // Store the old jersey and role before removing
  var oldJersey = existingPlayer ? existingPlayer.jersey : null;
  var oldRole = existingPlayer ? existingPlayer.role : null;
  
  // Remove existing player from this row temporarily for validation
  var otherPlayers = gameData.teams[teamKey].players.filter(function(p) {
    return p.row !== row;
  });
  
  if (jersey && name && role) {
    var jerseyNum = parseInt(jersey);
    
    if (isNaN(jerseyNum) || jerseyNum < 1 || jerseyNum > 99) {
      alert('‚ùå INVALID JERSEY NUMBER\n\nJersey must be between 1-99');
      document.getElementById(teamKey + '_jersey_' + row).value = oldJersey || '';
      updateCount(team);
      return;
    }
    
    // Check for duplicate jersey in OTHER players only (exclude current row)
    var duplicate = otherPlayers.find(function(p) {
      return parseInt(p.jersey) === jerseyNum;
    });
    
    if (duplicate) {
      alert('‚ùå DUPLICATE JERSEY NUMBER\n\nJersey #' + jerseyNum + ' is already used by:\n' + duplicate.name + ' (Row ' + (duplicate.row + 1) + ')\n\nEach player must have a unique jersey number.\n\nPlease choose a different number.');
      document.getElementById(teamKey + '_jersey_' + row).value = oldJersey || '';
      document.getElementById(teamKey + '_jersey_' + row).focus();
      updateCount(team);
      return;
    }
    
    // Check for duplicate roles in OTHER players only
    if (role === 'captain') {
      var existingCaptain = otherPlayers.find(function(p) { 
        return p.role === 'captain';
      });
      if (existingCaptain) {
        alert('‚ùå Team already has a Captain\n\n#' + existingCaptain.jersey + ' ' + existingCaptain.name + ' is already the captain.\n\nYou can only have ONE captain per team.');
        document.getElementById(teamKey + '_role_' + row).value = oldRole || 'player';
        // Re-add the existing player back
        gameData.teams[teamKey].players.push(existingPlayer);
        updateCount(team);
        return;
      }
    }
    
    if (role === 'libero1') {
      var existingLibero1 = otherPlayers.find(function(p) { 
        return p.role === 'libero1';
      });
      if (existingLibero1) {
        alert('‚ùå Team already has Libero 1\n\n#' + existingLibero1.jersey + ' ' + existingLibero1.name + ' is already Libero 1.\n\nYou can only have ONE Libero 1 per team.');
        document.getElementById(teamKey + '_role_' + row).value = oldRole || 'player';
        // Re-add the existing player back
        if (existingPlayer) gameData.teams[teamKey].players.push(existingPlayer);
        updateCount(team);
        return;
      }
    }
    
    if (role === 'libero2') {
      var existingLibero2 = otherPlayers.find(function(p) { 
        return p.role === 'libero2';
      });
      if (existingLibero2) {
        alert('‚ùå Team already has Libero 2\n\n#' + existingLibero2.jersey + ' ' + existingLibero2.name + ' is already Libero 2.\n\nYou can only have ONE Libero 2 per team.');
        document.getElementById(teamKey + '_role_' + row).value = oldRole || 'player';
        // Re-add the existing player back
        if (existingPlayer) gameData.teams[teamKey].players.push(existingPlayer);
        updateCount(team);
        return;
      }
    }
    
    // Validation passed - update the array with new player data
    gameData.teams[teamKey].players = otherPlayers;
    gameData.teams[teamKey].players.push({
      row: row,
      jersey: jerseyNum,
      name: name,
      role: role
    });
  } else {
    // If any field is empty, just remove the player from that row
    gameData.teams[teamKey].players = otherPlayers;
  }
  
  updateCount(team);
}

function updateCount(team) {
  var teamKey = 'team' + team;
  var count = gameData.teams[teamKey].players.length;
  document.getElementById('team' + team + 'Count').textContent = count;
}

function determineCoinTossOutcome() {
  var winner = document.getElementById('coinTossWinner').value;
  var choice = document.getElementById('coinTossChoice').value;
  
  if (!winner || !choice) {
    document.getElementById('coinTossResult').style.display = 'none';
    document.getElementById('teamAssignment').style.display = 'none';
    return;
  }
  
  // Show team assignment section
  document.getElementById('teamAssignment').style.display = 'block';
  
  var loser = winner === 'team1' ? 'team2' : 'team1';
  var team1Name = document.getElementById('team1Name').value || 'Team 1';
  var team2Name = document.getElementById('team2Name').value || 'Team 2';
  var winnerName = winner === 'team1' ? team1Name : team2Name;
  var loserName = loser === 'team1' ? team1Name : team2Name;
  
  var firstServer, firstReceiver, courtSides;
  
  if (choice === 'serve') {
    firstServer = winnerName + ' (chose to serve)';
    firstReceiver = loserName;
    courtSides = loserName + ' chooses their preferred side';
  } else if (choice === 'receive') {
    firstServer = loserName;
    firstReceiver = winnerName + ' (chose to receive)';
    courtSides = loserName + ' chooses their preferred side';
  } else if (choice === 'side') {
    firstServer = loserName + ' (will serve first)';
    firstReceiver = winnerName;
    courtSides = winnerName + ' chooses their preferred side';
  }
  
  document.getElementById('firstServer').textContent = firstServer;
  document.getElementById('firstReceiver').textContent = firstReceiver;
  document.getElementById('courtSides').textContent = courtSides;
  document.getElementById('coinTossResult').style.display = 'block';
}

function determineFirstServer(winner, choice) {
  // winner is 'team1' or 'team2', need to convert to A/B based on assignment
  var teamAAssignment = document.getElementById('teamAAssignment').value;
  var winnerIsA = (winner === teamAAssignment);
  var actualWinner = winnerIsA ? 'A' : 'B';
  
  if (choice === 'serve') {
    return actualWinner;
  } else if (choice === 'receive' || choice === 'side') {
    return actualWinner === 'A' ? 'B' : 'A';
  }
  return 'A';
}

function validateAndProceed() {
  console.log('=== validateAndProceed called ===');
  console.log('gameData.teams:', gameData.teams);
  
  // Check team assignment
  var teamAAssignment = document.getElementById('teamAAssignment').value;
  var teamBAssignment = document.getElementById('teamBAssignment').value;
  
  console.log('Team A Assignment:', teamAAssignment);
  console.log('Team B Assignment:', teamBAssignment);
  
  if (!teamAAssignment || !teamBAssignment) {
    alert('Please assign both teams to positions A and B in the Team Assignment section');
    return;
  }
  
  if (teamAAssignment === teamBAssignment) {
    alert('Each team must be assigned to a different position (A or B)');
    return;
  }
  
  // Check that teams have enough players
  console.log('team1 players:', gameData.teams.team1 ? gameData.teams.team1.players.length : 'team1 not found');
  console.log('team2 players:', gameData.teams.team2 ? gameData.teams.team2.players.length : 'team2 not found');
  
  if (!gameData.teams.team1 || gameData.teams.team1.players.length < 6) {
    alert('Team 1 needs at least 6 players. Currently has ' + (gameData.teams.team1 ? gameData.teams.team1.players.length : 0));
    return;
  }
  
  if (!gameData.teams.team2 || gameData.teams.team2.players.length < 6) {
    alert('Team 2 needs at least 6 players. Currently has ' + (gameData.teams.team2 ? gameData.teams.team2.players.length : 0));
    return;
  }
  
  // Check for duplicate jersey numbers in Team 1
  var team1Jerseys = {};
  var team1Duplicates = [];
  gameData.teams.team1.players.forEach(function(p) {
    var jersey = String(p.jersey);
    if (team1Jerseys[jersey]) {
      if (!team1Duplicates.includes(jersey)) {
        team1Duplicates.push(jersey);
      }
    }
    team1Jerseys[jersey] = true;
  });
  
  if (team1Duplicates.length > 0) {
    alert('‚ùå DUPLICATE JERSEY NUMBERS IN TEAM 1\n\nJersey #' + team1Duplicates.join(', #') + ' is used multiple times.\n\nEach player must have a unique jersey number.\n\nPlease fix the duplicates before proceeding.');
    return;
  }
  
  // Check for duplicate jersey numbers in Team 2
  var team2Jerseys = {};
  var team2Duplicates = [];
  gameData.teams.team2.players.forEach(function(p) {
    var jersey = String(p.jersey);
    if (team2Jerseys[jersey]) {
      if (!team2Duplicates.includes(jersey)) {
        team2Duplicates.push(jersey);
      }
    }
    team2Jerseys[jersey] = true;
  });
  
  if (team2Duplicates.length > 0) {
    alert('‚ùå DUPLICATE JERSEY NUMBERS IN TEAM 2\n\nJersey #' + team2Duplicates.join(', #') + ' is used multiple times.\n\nEach player must have a unique jersey number.\n\nPlease fix the duplicates before proceeding.');
    return;
  }
  
  var coinWinner = document.getElementById('coinTossWinner').value;
  var coinChoice = document.getElementById('coinTossChoice').value;
  
  console.log('Coin Toss Winner:', coinWinner);
  console.log('Coin Toss Choice:', coinChoice);
  
  if (!coinWinner || !coinChoice) {
    alert('Please complete the Coin Toss section (select winner and their choice)');
    return;
  }
  
  console.log('All validations passed, proceeding...');
  
  // Map team1/team2 to A/B based on assignment
  var sourceA = teamAAssignment; // 'team1' or 'team2'
  var sourceB = teamBAssignment; // 'team1' or 'team2'
  
  var team1Name = document.getElementById('team1Name').value;
  var team2Name = document.getElementById('team2Name').value;
  var team1Color = document.getElementById('team1Color').value;
  var team2Color = document.getElementById('team2Color').value;
  
  // Create A and B from assigned teams
  gameData.teams.A = {
    players: gameData.teams[sourceA].players.slice(),
    lineup: []
  };
  gameData.teams.B = {
    players: gameData.teams[sourceB].players.slice(),
    lineup: []
  };
  
  gameData.matchInfo = {
    date: document.getElementById('matchDate').value,
    time: document.getElementById('matchTime').value,
    competition: document.getElementById('comp').value,
    matchNumber: document.getElementById('matchNo').value,
    venue: document.getElementById('venue').value,
    format: document.getElementById('fmt').value,
    teamAName: sourceA === 'team1' ? team1Name : team2Name,
    teamBName: sourceB === 'team1' ? team1Name : team2Name,
    teamAColor: sourceA === 'team1' ? team1Color : team2Color,
    teamBColor: sourceB === 'team1' ? team1Color : team2Color,
    ref1: document.getElementById('ref1').value,
    ref2: document.getElementById('ref2').value,
    scorer: document.getElementById('scorer').value,
    assistScorer: document.getElementById('assistScorer').value
  };
  
  // Apply team colors dynamically
  applyTeamColors();
  
  gameData.coinToss = {
    winner: coinWinner,
    choice: coinChoice,
    firstServer: determineFirstServer(coinWinner, coinChoice)
  };
  
  showLineupSetup();
}

function applyTeamColors() {
  var colorA = gameData.matchInfo.teamAColor || '#ff6b6b';
  var colorB = gameData.matchInfo.teamBColor || '#4ecdc4';
  
  // Create or update style element for team colors
  var styleId = 'teamColorStyles';
  var styleElement = document.getElementById(styleId);
  
  if (!styleElement) {
    styleElement = document.createElement('style');
    styleElement.id = styleId;
    document.head.appendChild(styleElement);
  }
  
  styleElement.textContent = `
    :root {
      --team-a-color: ${colorA};
      --team-b-color: ${colorB};
    }
    .team-a { color: ${colorA} !important; }
    .team-b { color: ${colorB} !important; }
    .set-won-a { background: ${colorA} !important; border-color: ${colorA} !important; }
    .set-won-b { background: ${colorB} !important; border-color: ${colorB} !important; }
  `;
}

function showLineupSetup() {
  document.getElementById('teamANameSetup').textContent = gameData.matchInfo.teamAName;
  document.getElementById('teamBNameSetup').textContent = gameData.matchInfo.teamBName;
  
  renderRosterSetup('A');
  renderRosterSetup('B');
  
  document.getElementById('lineupModal').classList.add('active');
}

function renderRosterSetup(team) {
  var players = gameData.teams[team].players.filter(function(p) {
    return p.role !== 'libero1' && p.role !== 'libero2';
  }).sort(function(a, b) {
    return a.jersey - b.jersey;
  });
  
  var html = '';
  players.forEach(function(p) {
    var isReplaced = isPlayerReplacedByLibero(team, p.jersey);
    if (!isReplaced) {
      var badge = p.role === 'captain' ? ' <span style="background:#ffd700;color:#000;padding:2px 5px;border-radius:2px;font-size:9px;font-weight:bold">C</span>' : '';
      html += '<div class="roster-player" onclick="selectPlayerForLineup(\'' + team + '\',' + p.jersey + ')"><strong>#' + p.jersey + '</strong> ' + p.name + badge + '</div>';
    }
  });
  
  var liberos = gameData.teams[team].players.filter(function(p) {
    return p.role === 'libero1' || p.role === 'libero2';
  });
  
  liberos.forEach(function(p) {
    var replacingPlayer = getPlayerReplacedByLibero(team, p.jersey);
    if (replacingPlayer) {
      var badge = ' <span style="background:#9c27b0;color:#fff;padding:2px 5px;border-radius:2px;font-size:9px;font-weight:bold">LIBERO</span>';
      html += '<div class="roster-player" onclick="selectPlayerForLineup(\'' + team + '\',' + p.jersey + ')"><strong>#' + p.jersey + '</strong> ' + p.name + badge + '</div>';
    }
  });
  
  document.getElementById('roster' + team + 'Setup').innerHTML = html;
}

function selectPlayerForLineup(team, jersey) {
  gameData.selectedPlayer = {team: team, jersey: jersey};
  
  var players = document.querySelectorAll('#roster' + team + 'Setup .roster-player');
  players.forEach(function(el) {
    el.classList.remove('selected');
    if (el.textContent.includes('#' + jersey)) {
      el.classList.add('selected');
    }
  });
  
  var positions = document.querySelectorAll('#court' + team + 'Setup .court-setup-pos');
  positions.forEach(function(el) {
    el.style.cursor = 'pointer';
    el.style.opacity = '1';
  });
}

function assignPosition(team, pos) {
  if (!gameData.selectedPlayer || gameData.selectedPlayer.team !== team) {
    alert('Please select a player from ' + team + ' first');
    return;
  }
  
  var jersey = gameData.selectedPlayer.jersey;
  
  // Check if player is already assigned to another position
  var currentPositionIndex = gameData.teams[team].lineup.indexOf(jersey);
  if (currentPositionIndex !== -1 && currentPositionIndex !== (pos - 1)) {
    var playerInfo = gameData.teams[team].players.find(function(p) { return p.jersey === jersey; });
    var playerName = playerInfo ? playerInfo.name : 'Player';
    alert('‚ö†Ô∏è ' + playerName + ' (#' + jersey + ') is already assigned to Position ' + (currentPositionIndex + 1) + '.\n\nPlease click on their current position to remove them first, then assign to the new position.');
    return;
  }
  
  gameData.teams[team].lineup[pos - 1] = jersey;
  
  updateCourtSetup(team);
  gameData.selectedPlayer = null;
  
  var players = document.querySelectorAll('#roster' + team + 'Setup .roster-player');
  players.forEach(function(el) {
    el.classList.remove('selected');
  });
}

function updateCourtSetup(team) {
  var grid = document.getElementById('court' + team + 'Setup');
  var positions = grid.querySelectorAll('.court-setup-pos');
  
  positions.forEach(function(el) {
    var pos = parseInt(el.getAttribute('data-pos'));
    var jersey = gameData.teams[team].lineup[pos - 1];
    var player = jersey ? gameData.teams[team].players.find(function(p) { return p.jersey === jersey; }) : null;
    
    if (player) {
      el.classList.add('filled');
      el.querySelector('.pos-setup-num').textContent = '#' + player.jersey;
    } else {
      el.classList.remove('filled');
      el.querySelector('.pos-setup-num').textContent = '-';
    }
  });
}

function cancelLineup() {
  document.getElementById('lineupModal').classList.remove('active');
  gameData.teams.A.lineup = [];
  gameData.teams.B.lineup = [];
}

function startMatch() {
  console.log('=== START MATCH VALIDATION ===');
  console.log('Team A lineup:', gameData.teams.A.lineup);
  console.log('Team B lineup:', gameData.teams.B.lineup);
  
  // Filter out null, undefined, empty string, and 0
  var aFilled = gameData.teams.A.lineup.filter(function(x) { 
    return x !== null && x !== undefined && x !== '' && x !== 0; 
  }).length;
  var bFilled = gameData.teams.B.lineup.filter(function(x) { 
    return x !== null && x !== undefined && x !== '' && x !== 0; 
  }).length;
  
  console.log('Team A filled positions:', aFilled);
  console.log('Team B filled positions:', bFilled);
  
  if (aFilled !== 6) {
    alert('Team A needs exactly 6 players on court.\n\nCurrently has: ' + aFilled + ' players\n\nPlease assign all 6 positions.');
    return;
  }
  
  if (bFilled !== 6) {
    alert('Team B needs exactly 6 players on court.\n\nCurrently has: ' + bFilled + ' players\n\nPlease assign all 6 positions.');
    return;
  }
  
  // Remove the event listener so it doesn't fire again for subsequent sets
  document.getElementById('startMatchBtn').removeEventListener('click', startMatch);
  
  gameData.sets = [{
    score: {A: 0, B: 0},
    timeouts: {A: [], B: []},
    substitutions: {A: [], B: []},
    substitutionTracking: {A: {}, B: {}},
    completedSubstitutions: {A: [], B: []},
    serving: gameData.coinToss.firstServer,
    winner: null,
    startTime: Date.now(),
    lineupA: gameData.teams.A.lineup.slice(),
    lineupB: gameData.teams.B.lineup.slice()
  }];
  gameData.startTime = Date.now();
  gameData.setStartTime = Date.now();
  gameData.currentSet = 1;
  gameData.swapped = false;
  
  document.getElementById('lineupModal').classList.remove('active');
  document.getElementById('setupScreen').classList.add('hidden');
  document.getElementById('matchScreen').classList.remove('hidden');
  
  updateMatchDisplay();
  startMatchTimer();
}

function startMatchTimer() {
  // Update timers every second
  if (gameData.matchTimerInterval) {
    clearInterval(gameData.matchTimerInterval);
  }
  
  gameData.matchTimerInterval = setInterval(function() {
    updateTimerDisplay();
  }, 1000);
}

function updateTimerDisplay() {
  // Update Match Duration (adds 10 minutes to actual elapsed time)
  if (gameData.startTime) {
    var matchElapsed = Math.floor((Date.now() - gameData.startTime) / 1000);
    // Add 10 minutes (600 seconds) to the display
    matchElapsed += 600;
    
    var matchHours = Math.floor(matchElapsed / 3600);
    var matchMins = Math.floor((matchElapsed % 3600) / 60);
    var matchSecs = matchElapsed % 60;
    
    var matchDurationStr = 
      (matchHours < 10 ? '0' : '') + matchHours + ':' +
      (matchMins < 10 ? '0' : '') + matchMins + ':' +
      (matchSecs < 10 ? '0' : '') + matchSecs;
    
    document.getElementById('matchDuration').textContent = matchDurationStr;
  }
  
  // Update Set Duration
  if (gameData.setStartTime) {
    var setElapsed = Math.floor((Date.now() - gameData.setStartTime) / 1000);
    var setMins = Math.floor(setElapsed / 60);
    var setSecs = setElapsed % 60;
    
    var setDurationStr = 
      (setMins < 10 ? '0' : '') + setMins + ':' +
      (setSecs < 10 ? '0' : '') + setSecs;
    
    document.getElementById('setDuration').textContent = setDurationStr;
  }
}

function updateMatchDisplay() {
  console.log('=== UPDATE MATCH DISPLAY ===');
  console.log('Current Set Number:', gameData.currentSet);
  console.log('Total Sets in Array:', gameData.sets.length);
  console.log('Swapped:', gameData.swapped);
  
  var tA = gameData.swapped ? 'B' : 'A';
  var tB = gameData.swapped ? 'A' : 'B';
  var set = gameData.sets[gameData.currentSet - 1];
  
  console.log('Set Object:', set);
  
  if (!set) {
    console.error('ERROR: Set object is undefined! currentSet=' + gameData.currentSet + ', sets.length=' + gameData.sets.length);
    console.error('This should not happen! Aborting updateMatchDisplay.');
    return;
  }
  
  document.getElementById('topInfo').textContent = gameData.matchInfo.competition + ' | ' + gameData.matchInfo.venue;
  
  document.getElementById('nameDispA').textContent = gameData.matchInfo['team' + tA + 'Name'];
  document.getElementById('nameDispB').textContent = gameData.matchInfo['team' + tB + 'Name'];
  document.getElementById('courtNameA').textContent = gameData.matchInfo['team' + tA + 'Name'];
  document.getElementById('courtNameB').textContent = gameData.matchInfo['team' + tB + 'Name'];
  document.getElementById('sideATtl').textContent = gameData.matchInfo['team' + tA + 'Name'] + ' LINEUP';
  document.getElementById('sideBTtl').textContent = gameData.matchInfo['team' + tB + 'Name'] + ' LINEUP';
  
  document.getElementById('scoreDispA').textContent = set.score[tA];
  document.getElementById('scoreDispB').textContent = set.score[tB];
  
  document.getElementById('setDisp').textContent = gameData.currentSet;
  
  // Display sets won for the teams currently on each side (accounting for swaps)
  var setsWonByTeamA = gameData.sets.filter(function(s) { return s.winner === 'A'; }).length;
  var setsWonByTeamB = gameData.sets.filter(function(s) { return s.winner === 'B'; }).length;
  
  // setsA display shows the team currently on the A (left) side
  // If swapped, Team B is on the left, so show Team B's sets
  if (gameData.swapped) {
    document.getElementById('setsA').textContent = setsWonByTeamB;
    document.getElementById('setsB').textContent = setsWonByTeamA;
  } else {
    document.getElementById('setsA').textContent = setsWonByTeamA;
    document.getElementById('setsB').textContent = setsWonByTeamB;
  }
  
  document.getElementById('toDispA').textContent = set.timeouts[tA].length + '/2';
  document.getElementById('toDispB').textContent = set.timeouts[tB].length + '/2';
  
  // Calculate actual substitution count (completed substitutions count as 1)
  var subCountA = countCompletedSubstitutions(tA, gameData.currentSet - 1);
  var subCountB = countCompletedSubstitutions(tB, gameData.currentSet - 1);
  
  // completedSubstitutions is now {A: [], B: []} instead of a flat array
  if (set.completedSubstitutions) {
    // If it's the new structure (object with A and B keys)
    if (set.completedSubstitutions.A !== undefined && set.completedSubstitutions.B !== undefined) {
      var completedA = set.completedSubstitutions.A ? set.completedSubstitutions.A.length : 0;
      var completedB = set.completedSubstitutions.B ? set.completedSubstitutions.B.length : 0;
      // Each completed pair used 2 actions but counts as 1 substitution
      subCountA = subCountA - Math.floor(completedA / 2);
      subCountB = subCountB - Math.floor(completedB / 2);
    }
  }
  
  document.getElementById('subDispA').textContent = subCountA + '/6';
  document.getElementById('subDispB').textContent = subCountB + '/6';
  document.getElementById('servDispA').textContent = set.serving === tA ? 'YES' : 'NO';
  document.getElementById('servDispB').textContent = set.serving === tB ? 'YES' : 'NO';
  
  var maxSets = parseInt(gameData.matchInfo.format);
  var targetPoints = 25; // Default
  
  // Deciding set plays to 15
  if (maxSets === 5 && gameData.currentSet === 5) {
    targetPoints = 15;
  } else if (maxSets === 3 && gameData.currentSet === 3) {
    targetPoints = 15;
  }
  
  document.getElementById('setTypeDisp').textContent = '(First to ' + targetPoints + ', win by 2)';
  
  var dotsHTML = '';
  console.log('=== GENERATING SET DOTS ===');
  console.log('Total sets to display:', maxSets);
  console.log('Actual sets in array:', gameData.sets.length);
  
  for (var i = 0; i < maxSets; i++) {
    var s = gameData.sets[i];
    var dotClass = '';
    
    console.log('Set ' + (i+1) + ':', s ? {score: s.score, winner: s.winner} : 'undefined');
    
    if (s && s.winner) {
      // Permanently assign color based on team identity, never change
      // Team A always gets red (set-won-a), Team B always gets teal (set-won-b)
      if (s.winner === 'A') {
        dotClass = 'set-won-a'; // Team A won - always red
        console.log('  ‚Üí Applying red color (Team A won)');
      } else {
        dotClass = 'set-won-b'; // Team B won - always teal
        console.log('  ‚Üí Applying teal color (Team B won)');
      }
    } else {
      console.log('  ‚Üí No color (set not won yet)');
    }
    
    dotsHTML += '<div class="set-dot ' + dotClass + '">' + (i + 1) + '</div>';
  }
  document.getElementById('setDotsDisp').innerHTML = dotsHTML;
  
  updateCourtDisplay(tA, 'A');
  updateCourtDisplay(tB, 'B');
  
  updateLineupPanel(tA, 'A');
  updateLineupPanel(tB, 'B');
  
  // Share data with other display windows
  localStorage.setItem('volleyballGameData', JSON.stringify(gameData));
}

function updateCourtDisplay(team, side) {
  var grid = document.getElementById('courtGrid' + side);
  var positions = grid.querySelectorAll('.court-pos');
  var set = gameData.sets[gameData.currentSet - 1];
  
  positions.forEach(function(el) {
    var pos = parseInt(el.getAttribute('data-pos'));
    var jersey = gameData.teams[team].lineup[pos - 1];
    var player = jersey ? gameData.teams[team].players.find(function(p) { return p.jersey === jersey; }) : null;
    
    var jerseyEl = el.querySelector('.pos-jersey');
    if (!jerseyEl) {
      jerseyEl = document.createElement('div');
      jerseyEl.className = 'pos-jersey';
      el.appendChild(jerseyEl);
    }
    
    // Check if this position has a libero
    var isLiberoOnCourt = false;
    if (player && (player.role === 'libero1' || player.role === 'libero2')) {
      isLiberoOnCourt = true;
    }
    
    if (player) {
      jerseyEl.textContent = '#' + player.jersey;
    } else {
      jerseyEl.textContent = '-';
    }
    
    // Add libero highlighting
    if (isLiberoOnCourt) {
      el.classList.add('libero-on-court');
    } else {
      el.classList.remove('libero-on-court');
    }
    
    if (pos === 1 && set.serving === team) {
      el.classList.add('server');
    } else {
      el.classList.remove('server');
    }
  });
}

function updateLineupPanel(team, side) {
  var players = gameData.teams[team].players.sort(function(a, b) {
    return a.jersey - b.jersey;
  });
  
  var html = '';
  players.forEach(function(p) {
    var onCourt = gameData.teams[team].lineup.includes(p.jersey);
    var badge = '';
    if (p.role === 'captain') badge = '<span class="lineup-badge badge-c">C</span>';
    else if (p.role === 'libero1') badge = '<span class="lineup-badge badge-l">L1</span>';
    else if (p.role === 'libero2') badge = '<span class="lineup-badge badge-l">L2</span>';
    
    var pos = '';
    if (onCourt) {
      var idx = gameData.teams[team].lineup.indexOf(p.jersey);
      if (idx >= 0) pos = 'P' + (idx + 1);
    }
    
    html += '<div class="lineup-item">';
    html += '<div><span class="lineup-pos">' + pos + '</span> <strong>#' + p.jersey + '</strong> ' + p.name + badge + '</div>';
    if (onCourt) html += '<span class="on-court">‚óè</span>';
    html += '</div>';
  });
  
  document.getElementById('lineup' + side).innerHTML = html;
}

function addPointToTeam(team) {
  var set = gameData.sets[gameData.currentSet - 1];
  var opponent = team === 'A' ? 'B' : 'A';
  
  saveActionToHistory({
    type: 'point',
    team: team,
    previousScore: {A: set.score.A, B: set.score.B},
    previousServing: set.serving,
    previousLineupA: gameData.teams.A.lineup.slice(),
    previousLineupB: gameData.teams.B.lineup.slice(),
    previousLiberoReplacementsA: JSON.parse(JSON.stringify(gameData.liberoReplacements.A || [])),
    previousLiberoReplacementsB: JSON.parse(JSON.stringify(gameData.liberoReplacements.B || [])),
    setNumber: gameData.currentSet
  });
  
  set.score[team]++;
  
  // Add to match summary
  var teamName = team === 'A' ? gameData.matchInfo.teamAName : gameData.matchInfo.teamBName;
  addSummaryEvent('Pt', team, 'Point scored - Score: ' + set.score.A + '-' + set.score.B);
  
  if (set.serving !== team) {
    set.serving = team;
    rotateTeam(team);
  }
  
  // FIVB Rules: Determine target score based on current set number and format
  var maxSets = parseInt(gameData.matchInfo.format);
  var target = 25; // Default to 25 points
  
  // Deciding set (5th set in best of 5, 3rd set in best of 3) plays to 15 points
  if (maxSets === 5 && gameData.currentSet === 5) {
    target = 15; // 5th set in best of 5
  } else if (maxSets === 3 && gameData.currentSet === 3) {
    target = 15; // 3rd set in best of 3
  }
  
  console.log('Set ' + gameData.currentSet + ' target: ' + target + ' points (Format: Best of ' + maxSets + ')');
  
  // Must win by at least 2 points
  if (set.score[team] >= target && set.score[team] - set.score[opponent] >= 2) {
    console.log('=== SET WIN DETECTED ===');
    console.log('Winning team:', team);
    console.log('Score:', set.score[team] + '-' + set.score[opponent]);
    console.log('Setting set.winner =', team);
    
    set.winner = team;
    set.endTime = Date.now();
    
    console.log('After setting - set.winner:', set.winner);
    console.log('SET WON by Team ' + team + ': ' + set.score[team] + '-' + set.score[opponent]);
    
    // Add set win to summary
    addSummaryEvent('SET WIN', team, 'Won Set ' + gameData.currentSet + ' (' + set.score[team] + '-' + set.score[opponent] + ')');
    
    // Count how many sets each team has won
    var setsWonA = gameData.sets.filter(function(s) { return s.winner === 'A'; }).length;
    var setsWonB = gameData.sets.filter(function(s) { return s.winner === 'B'; }).length;
    var setsNeeded = maxSets === 5 ? 3 : 2;
    
    console.log('Sets won - Team A: ' + setsWonA + ', Team B: ' + setsWonB + ' (Need ' + setsNeeded + ' to win match)');
    
    // Check if a team has won the match
    if (setsWonA >= setsNeeded || setsWonB >= setsNeeded) {
      setTimeout(function() {
        alert('üèÜ ' + gameData.matchInfo['team' + team + 'Name'] + ' WINS THE MATCH!\n\nFinal Score: ' + set.score[team] + '-' + set.score[opponent]);
      }, 300);
    } else {
      setTimeout(function() {
        var msg = '‚úÖ SET ' + gameData.currentSet + ' COMPLETE!\n\n';
        msg += gameData.matchInfo['team' + team + 'Name'] + ' wins ' + set.score[team] + '-' + set.score[opponent] + '\n\n';
        
        // Check if next set is deciding set (Set 3 in best-of-3 or Set 5 in best-of-5)
        var maxSets = parseInt(gameData.matchInfo.format);
        var nextSetNum = gameData.currentSet + 1;
        var isDecidingSet = (maxSets === 3 && nextSetNum === 3) || (maxSets === 5 && nextSetNum === 5);
        
        if (isDecidingSet) {
          msg += 'üéØ DECIDING SET ' + nextSetNum + '!\n\n';
          msg += 'A new coin toss will be conducted.\n\n';
        } else {
          msg += 'üèê ' + gameData.matchInfo['team' + opponent + 'Name'] + ' will serve first in next set.\n\n';
        }
        msg += 'Start next set?';
        
        if (confirm(msg)) {
          if (isDecidingSet) {
            showDecidingSetToss();
          } else {
            startNextSet();
          }
        }
      }, 300);
    }
  }
  
  updateMatchDisplay();
}

function saveActionToHistory(action) {
  gameData.actionHistory.push(action);
  if (gameData.actionHistory.length > 50) {
    gameData.actionHistory.shift();
  }
}

function manualRotate(side) {
  var team = gameData.swapped ? (side === 'A' ? 'B' : 'A') : side;
  
  if (!confirm('üîÑ MANUAL ROTATION\n\nRotate ' + gameData.matchInfo['team' + team + 'Name'] + ' lineup?\n\nThis will rotate all positions clockwise:\nP1‚ÜíP6, P2‚ÜíP1, P3‚ÜíP2, P4‚ÜíP3, P5‚ÜíP4, P6‚ÜíP5\n\nNote: This should only be used for corrections, not during normal play.')) {
    return;
  }
  
  rotateTeam(team);
  updateMatchDisplay();
  
  addSummaryEvent('Manual Rotation', team, 'Manual rotation performed');
  
  alert('‚úì Rotation complete!\n\n' + gameData.matchInfo['team' + team + 'Name'] + ' lineup has been rotated.');
}

function rotateTeam(team) {
  var lineup = gameData.teams[team].lineup;
  var first = lineup.shift();
  lineup.push(first);
  
  autoReplaceLiberoInFrontRow(team);
}

function autoReplaceLiberoInFrontRow(team) {
  var frontRowIndices = [1, 2, 3];
  
  if (!gameData.liberoReplacements[team]) return;
  
  frontRowIndices.forEach(function(posIndex) {
    var jersey = gameData.teams[team].lineup[posIndex];
    
    var player = gameData.teams[team].players.find(function(p) { return p.jersey === jersey; });
    if (player && (player.role === 'libero1' || player.role === 'libero2')) {
      var replacement = gameData.liberoReplacements[team].find(function(r) {
        return r.libero === jersey;
      });
      
      if (replacement) {
        gameData.teams[team].lineup[posIndex] = replacement.originalPlayer;
        
        gameData.liberoReplacements[team] = gameData.liberoReplacements[team].filter(function(r) {
          return r.libero !== jersey;
        });
        
        console.log('Auto-replaced Libero #' + jersey + ' with original player #' + replacement.originalPlayer + ' at position P' + (posIndex + 1));
      }
    }
  });
}

var decidingSetTossData = {winner: null, choice: null};

function showDecidingSetToss() {
  decidingSetTossData = {winner: null, choice: null};
  
  document.getElementById('decidingTossAName').textContent = gameData.matchInfo.teamAName;
  document.getElementById('decidingTossBName').textContent = gameData.matchInfo.teamBName;
  
  // Reset UI
  document.getElementById('decidingTossA').style.border = '3px solid #533483';
  document.getElementById('decidingTossB').style.border = '3px solid #533483';
  document.getElementById('decidingTossChoice').style.display = 'none';
  
  document.getElementById('decidingSetTossModal').classList.add('active');
}

function decidingSetTossWinner(team) {
  decidingSetTossData.winner = team;
  
  // Highlight winner
  document.getElementById('decidingTossA').style.border = team === 'A' ? '3px solid #ff6b6b' : '3px solid #533483';
  document.getElementById('decidingTossB').style.border = team === 'B' ? '3px solid #4ecdc4' : '3px solid #533483';
  
  // Show choice
  document.getElementById('decidingTossWinnerName').textContent = gameData.matchInfo['team' + team + 'Name'];
  document.getElementById('decidingTossChoice').style.display = 'block';
}

function decidingSetTossChoice(choice) {
  decidingSetTossData.choice = choice;
  
  var winner = decidingSetTossData.winner;
  var loser = winner === 'A' ? 'B' : 'A';
  
  var firstServer;
  if (choice === 'serve') {
    firstServer = winner;
  } else {
    firstServer = loser;
  }
  
  // Save toss result
  gameData.decidingSetToss = {
    winner: winner,
    choice: choice,
    firstServer: firstServer,
    setNumber: gameData.currentSet + 1
  };
  
  closeDecidingSetTossModal();
  
  alert('üéØ DECIDING SET COIN TOSS RESULT\n\n' +
    'Toss Winner: ' + gameData.matchInfo['team' + winner + 'Name'] + '\n' +
    'Choice: ' + (choice === 'serve' ? 'SERVE FIRST' : 'RECEIVE FIRST') + '\n\n' +
    'First Server: ' + gameData.matchInfo['team' + firstServer + 'Name']);
  
  startNextSet();
}

function closeDecidingSetTossModal() {
  document.getElementById('decidingSetTossModal').classList.remove('active');
}

function startNextSet() {
  // Prevent double execution
  if (gameData.startingNextSet) {
    console.log('startNextSet already in progress, ignoring duplicate call');
    return;
  }
  gameData.startingNextSet = true;
  
  console.log('=== START NEXT SET CALLED ===');
  console.log('BEFORE Changes:');
  console.log('  currentSet:', gameData.currentSet);
  console.log('  sets.length:', gameData.sets.length);
  console.log('  swapped:', gameData.swapped);
  console.log('  sets array:', JSON.stringify(gameData.sets.map(function(s, i) {
    return {set: i+1, score: s.score, winner: s.winner};
  })));
  
  // Don't increment currentSet yet - it will be incremented when the set is actually created
  gameData.setStartTime = Date.now();
  
  // NO AUTOMATIC SWAPPING - user will manually swap using SWAP button if needed
  // gameData.swapped = !gameData.swapped; // REMOVED
  
  // Get the team that served first in the previous set (which is the current set that just finished)
  var prevSet = gameData.sets[gameData.currentSet - 1];
  console.log('Reading previous set from index:', gameData.currentSet - 1);
  console.log('Previous set object:', prevSet);
  
  if (!prevSet) {
    console.error('ERROR: prevSet is undefined!');
    alert('Error: Cannot find previous set data. currentSet=' + gameData.currentSet + ', sets.length=' + gameData.sets.length);
    gameData.startingNextSet = false;
    return;
  }
  
  var newFirstServer;
  
  // Check if this is a deciding set and we have toss data
  if (gameData.decidingSetToss && gameData.decidingSetToss.setNumber === (gameData.currentSet + 1)) {
    newFirstServer = gameData.decidingSetToss.firstServer;
    console.log('Using deciding set toss result - First server:', newFirstServer);
  } else {
    // Normal rule: team that did NOT serve first in previous set serves first
    var prevFirstServer = prevSet.serving;
    console.log('Previous set first server:', prevFirstServer);
    newFirstServer = prevFirstServer === 'A' ? 'B' : 'A';
    console.log('New first server for next set:', newFirstServer);
  }
  
  showNewSetLineupSetup(newFirstServer);
  
  // Reset flag after modal is shown
  setTimeout(function() {
    gameData.startingNextSet = false;
  }, 500);
}

function showNewSetLineupSetup(servingTeam) {
  gameData.selectedPlayer = null;
  
  gameData.teams.A.lineup = [];
  gameData.teams.B.lineup = [];
  
  document.getElementById('teamANameSetup').textContent = gameData.matchInfo.teamAName;
  document.getElementById('teamBNameSetup').textContent = gameData.matchInfo.teamBName;
  
  renderRosterSetup('A');
  renderRosterSetup('B');
  
  updateCourtSetup('A');
  updateCourtSetup('B');
  
  document.getElementById('lineupModal').classList.add('active');
  
  var nextSetNum = gameData.currentSet + 1;
  document.getElementById('startMatchBtn').textContent = 'Start Set ' + nextSetNum;
  
  document.getElementById('startMatchBtn').onclick = function() {
    console.log('=== NEW SET VALIDATION ===');
    console.log('Team A lineup:', gameData.teams.A.lineup);
    console.log('Team B lineup:', gameData.teams.B.lineup);
    
    var aFilled = gameData.teams.A.lineup.filter(function(x) { 
      return x !== null && x !== undefined && x !== '' && x !== 0; 
    }).length;
    var bFilled = gameData.teams.B.lineup.filter(function(x) { 
      return x !== null && x !== undefined && x !== '' && x !== 0; 
    }).length;
    
    console.log('Team A filled positions:', aFilled);
    console.log('Team B filled positions:', bFilled);
    
    if (aFilled !== 6) {
      alert('Team A needs exactly 6 players on court.\n\nCurrently has: ' + aFilled + ' players\n\nPlease assign all 6 positions.');
      return;
    }
    
    if (bFilled !== 6) {
      alert('Team B needs exactly 6 players on court.\n\nCurrently has: ' + bFilled + ' players\n\nPlease assign all 6 positions.');
      return;
    }
    
    console.log('=== BEFORE PUSH ===');
    console.log('currentSet before push:', gameData.currentSet);
    console.log('sets.length before push:', gameData.sets.length);
    
    gameData.sets.push({
      score: {A: 0, B: 0},
      timeouts: {A: [], B: []},
      substitutions: {A: [], B: []},
      substitutionTracking: {A: {}, B: {}},
      completedSubstitutions: {A: [], B: []},
      serving: servingTeam,
      winner: null,
      startTime: Date.now(),
      lineupA: gameData.teams.A.lineup.slice(),
      lineupB: gameData.teams.B.lineup.slice()
    });
    
    console.log('=== AFTER PUSH ===');
    console.log('sets.length after push:', gameData.sets.length);
    
    // Now increment currentSet since the new set has been created
    console.log('currentSet before increment:', gameData.currentSet);
    gameData.currentSet++;
    console.log('=== NEW SET CREATED ===');
    console.log('New currentSet:', gameData.currentSet);
    console.log('Total sets:', gameData.sets.length);
    
    document.getElementById('lineupModal').classList.remove('active');
    updateMatchDisplay();
  };
}

function addPoint(side) {
  var team = gameData.swapped ? (side === 'A' ? 'B' : 'A') : side;
  addPointToTeam(team);
}

function swapSides() {
  gameData.swapped = !gameData.swapped;
  updateMatchDisplay();
}

function undoPoint() {
  if (gameData.actionHistory.length === 0) {
    alert('No actions to undo');
    return;
  }
  
  var lastAction = gameData.actionHistory.pop();
  var set = gameData.sets[gameData.currentSet - 1];
  
  if (lastAction.type === 'point') {
    set.score.A = lastAction.previousScore.A;
    set.score.B = lastAction.previousScore.B;
    
    set.serving = lastAction.previousServing;
    
    gameData.teams.A.lineup = lastAction.previousLineupA;
    gameData.teams.B.lineup = lastAction.previousLineupB;
    
    if (lastAction.previousLiberoReplacementsA) {
      gameData.liberoReplacements.A = JSON.parse(JSON.stringify(lastAction.previousLiberoReplacementsA));
    }
    if (lastAction.previousLiberoReplacementsB) {
      gameData.liberoReplacements.B = JSON.parse(JSON.stringify(lastAction.previousLiberoReplacementsB));
    }
    
    if (set.winner) {
      set.winner = null;
      delete set.endTime;
    }
    
    updateMatchDisplay();
    
    var teamName = gameData.matchInfo['team' + lastAction.team + 'Name'];
    alert('‚úì Undone: Point for ' + teamName + '\nScore restored to ' + 
          lastAction.previousScore.A + '-' + lastAction.previousScore.B);
  } else if (lastAction.type === 'timeout') {
    set.timeouts[lastAction.team].pop();
    updateMatchDisplay();
    updateTimeoutHistory();
    alert('‚úì Undone: Timeout for ' + gameData.matchInfo['team' + lastAction.team + 'Name']);
  } else if (lastAction.type === 'substitution') {
    set.substitutions[lastAction.team].pop();
    var posIndex = gameData.teams[lastAction.team].lineup.indexOf(lastAction.playerIn);
    if (posIndex !== -1) {
      gameData.teams[lastAction.team].lineup[posIndex] = lastAction.playerOut;
    }
    updateMatchDisplay();
    alert('‚úì Undone: Substitution for ' + gameData.matchInfo['team' + lastAction.team + 'Name']);
  } else if (lastAction.type === 'libero') {
    gameData.liberoReplacements[lastAction.team] = gameData.liberoReplacements[lastAction.team].filter(function(r) {
      return !(r.libero === lastAction.libero && r.originalPlayer === lastAction.originalPlayer);
    });
    var posIndex = gameData.teams[lastAction.team].lineup.indexOf(lastAction.libero);
    if (posIndex !== -1) {
      gameData.teams[lastAction.team].lineup[posIndex] = lastAction.originalPlayer;
    }
    updateMatchDisplay();
    alert('‚úì Undone: Libero replacement for ' + gameData.matchInfo['team' + lastAction.team + 'Name']);
  } else if (lastAction.type === 'manual_rotate') {
    gameData.teams[lastAction.team].lineup = lastAction.previousLineup;
    gameData.liberoReplacements[lastAction.team] = JSON.parse(JSON.stringify(lastAction.previousLiberoReplacements));
    updateMatchDisplay();
    alert('‚úì Undone: Manual rotation for ' + gameData.matchInfo['team' + lastAction.team + 'Name']);
  }
}

function takeTimeout(side) {
  var team = gameData.swapped ? (side === 'A' ? 'B' : 'A') : side;
  var set = gameData.sets[gameData.currentSet - 1];
  
  if (set.timeouts[team].length >= 2) {
    alert('Maximum 2 timeouts per set');
    return;
  }
  
  var teamName = gameData.matchInfo['team' + team + 'Name'];
  var tA = gameData.swapped ? 'B' : 'A';
  var tB = gameData.swapped ? 'A' : 'B';
  
  set.timeouts[team].push({
    time: Date.now(),
    score: {A: set.score.A, B: set.score.B}
  });
  
  // Add to match summary
  addSummaryEvent('TO', team, 'Timeout #' + set.timeouts[team].length + ' at ' + set.score.A + '-' + set.score.B);
  
  document.getElementById('timeoutTeamName').textContent = teamName + ' - TIMEOUT';
  
  // Update the new score display
  document.getElementById('timeoutTeamAName').textContent = gameData.matchInfo['team' + tA + 'Name'];
  document.getElementById('timeoutTeamBName').textContent = gameData.matchInfo['team' + tB + 'Name'];
  document.getElementById('timeoutTeamAScore').textContent = set.score[tA];
  document.getElementById('timeoutTeamBScore').textContent = set.score[tB];
  
  gameData.timeoutRemaining = 30;
  gameData.currentTimeoutTeam = team;
  document.getElementById('timeoutTimer').textContent = '30';
  document.getElementById('timeoutModal').classList.add('active');
  
  gameData.timeoutTimer = setInterval(function() {
    gameData.timeoutRemaining--;
    document.getElementById('timeoutTimer').textContent = gameData.timeoutRemaining;
    
    if (gameData.timeoutRemaining <= 0) {
      endTimeout();
    }
  }, 1000);
  
  updateMatchDisplay();
}

function endTimeout() {
  if (gameData.timeoutTimer) {
    clearInterval(gameData.timeoutTimer);
    gameData.timeoutTimer = null;
  }
  document.getElementById('timeoutModal').classList.remove('active');
  gameData.currentTimeoutTeam = null;
}

function openSubModal(side) {
  var team = gameData.swapped ? (side === 'A' ? 'B' : 'A') : side;
  var set = gameData.sets[gameData.currentSet - 1];
  
  // Ensure team-specific tracking exists
  if (!set.substitutionTracking) {
    set.substitutionTracking = {A: {}, B: {}};
  }
  if (!set.substitutionTracking[team]) {
    set.substitutionTracking[team] = {};
  }
  
  // Clean up invalid entries for THIS team only
  if (set.substitutionTracking[team]) {
    var teamJerseys = gameData.teams[team].players.map(function(p) { return String(p.jersey); });
    
    // Remove pairings that reference non-existent players in this team
    var keysToDelete = [];
    Object.keys(set.substitutionTracking[team]).forEach(function(jersey) {
      var pairedWith = set.substitutionTracking[team][jersey].pairedWith;
      
      // If either player doesn't exist in THIS team's roster, mark for deletion
      if (!teamJerseys.includes(jersey) || !teamJerseys.includes(pairedWith)) {
        keysToDelete.push(jersey);
      }
    });
    
    keysToDelete.forEach(function(key) {
      delete set.substitutionTracking[team][key];
    });
  }
  
  // Calculate actual substitution count (completed substitutions count as 1)
  var actualSubCount = countCompletedSubstitutions(team, gameData.currentSet - 1);
  
  if (actualSubCount >= 6) {
    alert('Maximum 6 substitutions per set reached');
    return;
  }
  
  gameData.subSelection = {playerOut: null, playerIn: null, team: team, side: side};
  
  document.getElementById('subTeamName').textContent = gameData.matchInfo['team' + team + 'Name'];
  document.getElementById('subInfo').textContent = 'Substitution ' + (actualSubCount + 1) + '/6 - Select player OUT, then player IN';
  
  renderSubPlayers(team);
  document.getElementById('subModal').classList.add('active');
}

function renderSubPlayers(team) {
  var onCourt = gameData.teams[team].lineup.filter(function(j) { return j; });
  var allPlayers = gameData.teams[team].players;
  
  // Get players currently replaced by liberos
  var replacedByLibero = [];
  if (gameData.liberoReplacements && gameData.liberoReplacements[team]) {
    gameData.liberoReplacements[team].forEach(function(replacement) {
      // If libero is currently on court, the original player is replaced and on bench
      if (onCourt.includes(replacement.libero)) {
        replacedByLibero.push(replacement.originalPlayer);
      }
    });
  }
  
  var onBench = allPlayers.filter(function(p) { 
    // Exclude: players on court, liberos, and players replaced by liberos
    return !onCourt.includes(p.jersey) && 
           p.role !== 'libero1' && 
           p.role !== 'libero2' &&
           !replacedByLibero.includes(p.jersey);
  });
  
  var outHTML = '';
  onCourt.forEach(function(jersey) {
    var player = allPlayers.find(function(p) { return p.jersey === jersey; });
    if (player) {
      // Check if this is a libero on court
      var isLibero = (player.role === 'libero1' || player.role === 'libero2');
      
      // Liberos on court cannot be substituted (only replaced by original player via libero replacement)
      if (!isLibero) {
        var badge = player.role === 'captain' ? ' (C)' : '';
        outHTML += '<div class="player-select-btn" onclick="selectPlayerOut(' + jersey + ')">';
        outHTML += '<strong>#' + player.jersey + '</strong> ' + player.name + badge;
        outHTML += '</div>';
      }
    }
  });
  
  // Add info about liberos on court
  var liberosOnCourt = [];
  onCourt.forEach(function(jersey) {
    var player = allPlayers.find(function(p) { return p.jersey === jersey; });
    if (player && (player.role === 'libero1' || player.role === 'libero2')) {
      liberosOnCourt.push(player);
    }
  });
  
  if (liberosOnCourt.length > 0) {
    outHTML += '<div style="background:#9c27b0;color:#fff;padding:8px;margin-top:10px;border-radius:4px;font-size:11px;">';
    outHTML += '‚ö†Ô∏è Liberos cannot be substituted. Use Libero Replacement:<br>';
    liberosOnCourt.forEach(function(lib) {
      outHTML += '‚Ä¢ L#' + lib.jersey + ' ' + lib.name + '<br>';
    });
    outHTML += '</div>';
  }
  
  document.getElementById('playersOut').innerHTML = outHTML || '<p style="color:#888">No players on court</p>';
  
  var inHTML = '';
  onBench.forEach(function(player) {
    var badge = player.role === 'captain' ? ' (C)' : '';
    inHTML += '<div class="player-select-btn" onclick="selectPlayerIn(' + player.jersey + ')">';
    inHTML += '<strong>#' + player.jersey + '</strong> ' + player.name + badge;
    inHTML += '</div>';
  });
  
  // Add info message if players are blocked
  if (replacedByLibero.length > 0) {
    inHTML += '<div style="background:#9c27b0;color:#fff;padding:8px;margin-top:10px;border-radius:4px;font-size:11px;">';
    inHTML += '‚ö†Ô∏è Players replaced by libero cannot be substituted:<br>';
    replacedByLibero.forEach(function(jersey) {
      var p = allPlayers.find(function(player) { return player.jersey === jersey; });
      if (p) {
        inHTML += '‚Ä¢ #' + jersey + ' ' + p.name + '<br>';
      }
    });
    inHTML += '</div>';
  }
  
  document.getElementById('playersIn').innerHTML = inHTML || '<p style="color:#888">No players on bench</p>';
}

function selectPlayerOut(jersey) {
  gameData.subSelection.playerOut = jersey;
  
  var buttons = document.querySelectorAll('#playersOut .player-select-btn');
  buttons.forEach(function(btn) {
    btn.classList.remove('selected');
    // Extract jersey number from button text and compare exactly
    var match = btn.textContent.match(/#(\d+)/);
    if (match && parseInt(match[1]) === jersey) {
      btn.classList.add('selected');
    }
  });
  
  updateSubInfo();
}

function selectPlayerIn(jersey) {
  gameData.subSelection.playerIn = jersey;
  
  var buttons = document.querySelectorAll('#playersIn .player-select-btn');
  buttons.forEach(function(btn) {
    btn.classList.remove('selected');
    // Extract jersey number from button text and compare exactly
    var match = btn.textContent.match(/#(\d+)/);
    if (match && parseInt(match[1]) === jersey) {
      btn.classList.add('selected');
    }
  });
  
  updateSubInfo();
}

function updateSubInfo() {
  var sel = gameData.subSelection;
  var team = sel.team;
  var allPlayers = gameData.teams[team].players;
  
  var outPlayer = sel.playerOut ? allPlayers.find(function(p) { return p.jersey === sel.playerOut; }) : null;
  var inPlayer = sel.playerIn ? allPlayers.find(function(p) { return p.jersey === sel.playerIn; }) : null;
  
  var msg = '';
  if (outPlayer && inPlayer) {
    msg = 'OUT: #' + outPlayer.jersey + ' ' + outPlayer.name + ' ‚Üí IN: #' + inPlayer.jersey + ' ' + inPlayer.name;
  } else if (outPlayer) {
    msg = 'Selected OUT: #' + outPlayer.jersey + ' ' + outPlayer.name + ' - Now select player IN';
  } else {
    msg = 'Select player OUT, then player IN';
  }
  
  document.getElementById('subInfo').textContent = msg;
}

function confirmSubstitution() {
  var sel = gameData.subSelection;
  
  if (!sel.playerOut || !sel.playerIn) {
    alert('Please select both OUT and IN players');
    return;
  }
  
  var team = sel.team;
  var set = gameData.sets[gameData.currentSet - 1];
  
  var posIndex = gameData.teams[team].lineup.indexOf(sel.playerOut);
  
  if (posIndex === -1) {
    alert('Error: Player not found on court');
    return;
  }
  
  // FIVB Rule: Track substitutions per team
  if (!set.substitutionTracking) {
    set.substitutionTracking = {A: {}, B: {}};
  }
  if (!set.substitutionTracking[team]) {
    set.substitutionTracking[team] = {};
  }
  
  if (!set.completedSubstitutions) {
    set.completedSubstitutions = {A: [], B: []};
  }
  if (!set.completedSubstitutions[team]) {
    set.completedSubstitutions[team] = [];
  }
  
  var playerOutStr = String(sel.playerOut);
  var playerInStr = String(sel.playerIn);
  
  // Rule 1: Once a player has completed their substitution, they CANNOT go out again
  if (set.completedSubstitutions[team].includes(playerOutStr)) {
    alert('‚ùå INVALID SUBSTITUTION!\n\nFIVB Rule: Player #' + playerOutStr + ' has completed their substitution.\n\nAfter completing a substitution (OUT then back IN with same player), both players cannot be substituted again in this set.');
    return;
  }
  
  // Rule 2: If playerOut is already paired with someone, they can ONLY substitute with that same player
  if (set.substitutionTracking[team][playerOutStr]) {
    var pairedPlayer = set.substitutionTracking[team][playerOutStr].pairedWith;
    if (pairedPlayer !== playerInStr) {
      alert('‚ùå INVALID SUBSTITUTION!\n\nFIVB Rule: Player #' + playerOutStr + ' is paired with Player #' + pairedPlayer + '.\n\nPlayer #' + playerOutStr + ' can ONLY substitute with Player #' + pairedPlayer + ' (not with Player #' + playerInStr + ').');
      return;
    }
  }
  
  // Rule 3: If playerIn is already paired with someone, they can ONLY substitute with that same player
  if (set.substitutionTracking[team][playerInStr]) {
    var pairedPlayer = set.substitutionTracking[team][playerInStr].pairedWith;
    if (pairedPlayer !== playerOutStr) {
      alert('‚ùå INVALID SUBSTITUTION!\n\nFIVB Rule: Player #' + playerInStr + ' is paired with Player #' + pairedPlayer + '.\n\nPlayer #' + playerInStr + ' can ONLY substitute with Player #' + pairedPlayer + ' (not with Player #' + playerOutStr + ').');
      return;
    }
  }
  
  saveActionToHistory({
    type: 'substitution',
    team: team,
    playerOut: sel.playerOut,
    playerIn: sel.playerIn,
    position: posIndex + 1,
    setNumber: gameData.currentSet
  });
  
  // Track in set.substitutions
  set.substitutions[team].push({
    time: Date.now(),
    score: {A: set.score.A, B: set.score.B},
    playerOut: sel.playerOut,
    playerIn: sel.playerIn,
    position: posIndex + 1
  });
  
  // Add to match summary
  var outPlayer = gameData.teams[team].players.find(function(p) { return p.jersey === sel.playerOut; });
  var inPlayer = gameData.teams[team].players.find(function(p) { return p.jersey === sel.playerIn; });
  addSummaryEvent('S', team, 'Substitution: #' + sel.playerOut + ' OUT, #' + sel.playerIn + ' IN at P' + (posIndex + 1));
  
  // Update tracking (team-specific)
  var isReturning = set.substitutionTracking[team][playerOutStr] && 
                    set.substitutionTracking[team][playerOutStr].pairedWith === playerInStr;
  
  if (isReturning) {
    // This is a return - COMPLETES the substitution for BOTH players
    set.substitutionTracking[team][playerOutStr].completed = true;
    set.substitutionTracking[team][playerInStr].completed = true;
    
    // Mark BOTH players as having completed their substitution
    if (!set.completedSubstitutions[team].includes(playerInStr)) {
      set.completedSubstitutions[team].push(playerInStr);
    }
    if (!set.completedSubstitutions[team].includes(playerOutStr)) {
      set.completedSubstitutions[team].push(playerOutStr);
    }
    
  } else {
    // New substitution - create the pairing for BOTH players
    set.substitutionTracking[team][playerOutStr] = {
      pairedWith: playerInStr,
      completed: false
    };
    set.substitutionTracking[team][playerInStr] = {
      pairedWith: playerOutStr,
      completed: false
    };
  }
  
  gameData.teams[team].lineup[posIndex] = sel.playerIn;
  
  closeSubModal();
  updateMatchDisplay();
  
  var outPlayer = gameData.teams[team].players.find(function(p) { return p.jersey === sel.playerOut; });
  var inPlayer = gameData.teams[team].players.find(function(p) { return p.jersey === sel.playerIn; });
  
  var msg = '‚úì Substitution complete!\nOUT: #' + outPlayer.jersey + ' ' + outPlayer.name + '\nIN: #' + inPlayer.jersey + ' ' + inPlayer.name;
  
  if (isReturning) {
    msg += '\n\nüìã SUBSTITUTION COMPLETED (counts as 1 substitution)';
    msg += '\n‚ö†Ô∏è Players #' + outPlayer.jersey + ' and #' + inPlayer.jersey + ' cannot be substituted again in this set.';
  } else {
    msg += '\n\nüìã Players #' + outPlayer.jersey + ' and #' + inPlayer.jersey + ' are now paired.';
    msg += '\n‚ö†Ô∏è They can ONLY substitute with each other for the rest of this set.';
  }
  
  alert(msg);
}

function countCompletedSubstitutions(team, setIndex) {
  var set = gameData.sets[setIndex];
  if (!set || !set.substitutions || !set.substitutions[team]) {
    return 0;
  }
  
  // Create a map of substitution pairs
  var pairs = {};
  
  set.substitutions[team].forEach(function(sub) {
    var key = [String(sub.playerOut), String(sub.playerIn)].sort().join('-');
    
    if (!pairs[key]) {
      pairs[key] = 1;
    } else {
      pairs[key] = 2; // Pair completed (A‚ÜíB then B‚ÜíA)
    }
  });
  
  // Count: each unique pair counts as 1 substitution
  // (whether it's incomplete 1 move, or complete 2 moves)
  return Object.keys(pairs).length;
}

function closeSubModal() {
  document.getElementById('subModal').classList.remove('active');
  gameData.subSelection = {playerOut: null, playerIn: null, team: null};
}

function openLiberoModal(side) {
  var team = gameData.swapped ? (side === 'A' ? 'B' : 'A') : side;
  
  var liberos = gameData.teams[team].players.filter(function(p) {
    return p.role === 'libero1' || p.role === 'libero2';
  });
  
  if (liberos.length === 0) {
    alert('No liberos available for ' + gameData.matchInfo['team' + team + 'Name']);
    return;
  }
  
  gameData.liberoSelection = {libero: null, playerOut: null, team: team, side: side};
  
  document.getElementById('liberoTeamName').textContent = gameData.matchInfo['team' + team + 'Name'];
  
  var set = gameData.sets[gameData.currentSet - 1];
  var isServing = set.serving === team;
  
  var infoText = '‚ö†Ô∏è IMPORTANT: Libero can ONLY replace BACK-ROW players (P1, P5, P6). Front-row replacements are NOT allowed!';
  if (isServing) {
    infoText += '\n\nüö´ LIBERO CANNOT SERVE: Cannot replace P1 while your team has service!';
  }
  
  document.getElementById('liberoInfo').textContent = infoText;
  
  renderLiberoOptions(team);
  document.getElementById('liberoModal').classList.add('active');
}

function renderLiberoOptions(team) {
  var liberos = gameData.teams[team].players.filter(function(p) {
    return p.role === 'libero1' || p.role === 'libero2';
  });
  
  // Check if any libero is already on court
  var liberoOnCourt = null;
  liberos.forEach(function(libero) {
    if (gameData.teams[team].lineup.includes(libero.jersey)) {
      liberoOnCourt = libero.jersey;
    }
  });
  
  var liberosHTML = '';
  liberos.forEach(function(p) {
    var onCourt = gameData.teams[team].lineup.includes(p.jersey);
    var badge = p.role === 'libero1' ? 'L1' : 'L2';
    
    // Disable this libero if another libero is already on court
    var disabled = (liberoOnCourt && liberoOnCourt !== p.jersey);
    var disabledClass = disabled ? ' disabled' : '';
    var disabledStyle = disabled ? 'opacity:0.5;cursor:not-allowed;' : '';
    
    liberosHTML += '<div class="libero-player-btn libero' + disabledClass + '" onclick="' + (disabled ? '' : 'selectLibero(' + p.jersey + ')') + '" style="' + disabledStyle + '">';
    liberosHTML += '<strong>#' + p.jersey + '</strong> ' + p.name;
    liberosHTML += '<span class="libero-badge-big">' + badge + '</span>';
    if (onCourt) {
      liberosHTML += '<div style="color:#00ff00;font-size:11px;margin-top:3px;font-weight:bold">‚óè ON COURT</div>';
    } else if (disabled) {
      liberosHTML += '<div style="color:#ff6b6b;font-size:10px;margin-top:3px">‚õî Other libero on court</div>';
    }
    liberosHTML += '</div>';
  });
  document.getElementById('liberosList').innerHTML = liberosHTML;
  
  var backRowPositions = [1, 5, 6];
  var backRowHTML = '';
  
  var set = gameData.sets[gameData.currentSet - 1];
  var isServing = set.serving === team;
  
  backRowPositions.forEach(function(pos) {
    var jersey = gameData.teams[team].lineup[pos - 1];
    if (jersey) {
      var player = gameData.teams[team].players.find(function(p) { return p.jersey === jersey; });
      if (player && player.role !== 'libero1' && player.role !== 'libero2') {
        var badge = player.role === 'captain' ? ' (C)' : '';
        var posLabel = pos === 1 ? 'P1-RB (Back)' : pos === 5 ? 'P5-LB (Back)' : 'P6-MB (Back)';
        
        // Disable P1 if team is serving (libero cannot serve)
        var disabled = (pos === 1 && isServing);
        var disabledClass = disabled ? ' disabled' : '';
        var disabledStyle = disabled ? 'opacity:0.5;cursor:not-allowed;' : '';
        var servingWarning = disabled ? '<div style="color:#ff6b6b;font-size:9px;margin-top:3px">‚ö†Ô∏è CANNOT SERVE</div>' : '';
        
        backRowHTML += '<div class="libero-player-btn' + disabledClass + '" style="' + disabledStyle + '" onclick="' + (disabled ? 'alert(\'‚õî LIBERO CANNOT SERVE!\\n\\nLibero cannot replace P1 while your team has service.\')' : 'selectBackRowPlayer(' + jersey + ', ' + pos + ')') + '">';
        backRowHTML += '<strong>#' + player.jersey + '</strong> ' + player.name + badge;
        backRowHTML += '<div style="color:#00d9ff;font-size:10px;margin-top:3px">' + posLabel + '</div>';
        backRowHTML += servingWarning;
        backRowHTML += '</div>';
      }
    }
  });
  
  if (!backRowHTML) {
    backRowHTML = '<p style="color:#888;padding:10px">No eligible back-row players (P1, P5, P6 only)</p>';
  }
  
  document.getElementById('backRowPlayers').innerHTML = backRowHTML;
}

function selectLibero(jersey) {
  var onCourt = gameData.teams[gameData.liberoSelection.team].lineup.includes(jersey);
  
  if (onCourt) {
    if (confirm('This libero is already on court. Remove libero from court?')) {
      removeLiberoFromCourt(jersey);
    }
    return;
  }
  
  gameData.liberoSelection.libero = jersey;
  
  var buttons = document.querySelectorAll('#liberosList .libero-player-btn');
  buttons.forEach(function(btn) {
    btn.classList.remove('selected');
    if (btn.textContent.includes('#' + jersey)) {
      btn.classList.add('selected');
    }
  });
  
  updateLiberoInfo();
}

function selectBackRowPlayer(jersey, position) {
  gameData.liberoSelection.playerOut = jersey;
  gameData.liberoSelection.position = position;
  
  var buttons = document.querySelectorAll('#backRowPlayers .libero-player-btn');
  buttons.forEach(function(btn) {
    btn.classList.remove('selected');
    if (btn.textContent.includes('#' + jersey)) {
      btn.classList.add('selected');
    }
  });
  
  updateLiberoInfo();
}

function updateLiberoInfo() {
  var sel = gameData.liberoSelection;
  var team = sel.team;
  var allPlayers = gameData.teams[team].players;
  
  var libero = sel.libero ? allPlayers.find(function(p) { return p.jersey === sel.libero; }) : null;
  var playerOut = sel.playerOut ? allPlayers.find(function(p) { return p.jersey === sel.playerOut; }) : null;
  
  var msg = '';
  if (libero && playerOut) {
    msg = 'Replace #' + playerOut.jersey + ' ' + playerOut.name + ' with LIBERO #' + libero.jersey + ' ' + libero.name;
  } else if (libero) {
    msg = 'Selected LIBERO #' + libero.jersey + ' ' + libero.name + ' - Now select back-row player to replace';
  } else if (playerOut) {
    msg = 'Selected #' + playerOut.jersey + ' ' + playerOut.name + ' - Now select a Libero';
  } else {
    msg = 'Select a Libero and a back-row player to replace';
  }
  
  document.getElementById('liberoInfo').textContent = msg;
}

function confirmLiberoReplacement() {
  var sel = gameData.liberoSelection;
  
  if (!sel.libero || !sel.playerOut) {
    alert('Please select both a Libero and a back-row player');
    return;
  }
  
  var team = sel.team;
  var set = gameData.sets[gameData.currentSet - 1];
  
  // Check if another libero is already on court
  var allLiberos = gameData.teams[team].players.filter(function(p) {
    return p.role === 'libero1' || p.role === 'libero2';
  });
  
  var otherLiberoOnCourt = false;
  var otherLiberoJersey = null;
  allLiberos.forEach(function(libero) {
    if (libero.jersey !== sel.libero && gameData.teams[team].lineup.includes(libero.jersey)) {
      otherLiberoOnCourt = true;
      otherLiberoJersey = libero.jersey;
    }
  });
  
  if (otherLiberoOnCourt) {
    var otherLibero = gameData.teams[team].players.find(function(p) { return p.jersey === otherLiberoJersey; });
    var badge = otherLibero.role === 'libero1' ? 'L1' : 'L2';
    alert('‚õî ONLY ONE LIBERO ALLOWED ON COURT!\n\nLibero #' + otherLiberoJersey + ' ' + otherLibero.name + ' (' + badge + ') is already on court.\n\nYou must remove the current libero before bringing in another libero.\n\nTo replace: Click on the current libero and select the original player to bring them back.');
    return;
  }
  
  var posIndex = gameData.teams[team].lineup.indexOf(sel.playerOut);
  
  if (posIndex === -1) {
    alert('Error: Player not found on court');
    return;
  }
  
  var backRowIndices = [0, 4, 5]; // P1, P5, P6
  if (!backRowIndices.includes(posIndex)) {
    alert('‚õî LIBERO RULE VIOLATION!\n\nLibero can ONLY replace back-row players (P1, P5, P6).\n\nThis player is in position P' + (posIndex + 1) + ' which is FRONT ROW.\n\nPlease select a back-row player.');
    return;
  }
  
  // FIVB Rule: Libero CANNOT serve, so cannot replace P1 when their team is serving
  if (posIndex === 0 && set.serving === team) {
    alert('‚õî LIBERO CANNOT SERVE!\n\nFIVB Rule: The Libero is NOT allowed to serve.\n\nPosition P1 (Right Back) is currently the serving position for ' + gameData.matchInfo['team' + team + 'Name'] + '.\n\nLibero cannot replace the player in P1 while your team has service.\n\nWait until service changes or use a regular substitution.');
    return;
  }
  
  if (!gameData.liberoReplacements[team]) {
    gameData.liberoReplacements[team] = [];
  }
  
  var existingReplacement = gameData.liberoReplacements[team].find(function(r) {
    return r.libero === sel.libero;
  });
  
  if (existingReplacement) {
    var originalPlayer = existingReplacement.originalPlayer;
    var originalPos = gameData.teams[team].lineup.indexOf(sel.libero);
    if (originalPos !== -1) {
      gameData.teams[team].lineup[originalPos] = originalPlayer;
    }
    
    gameData.liberoReplacements[team] = gameData.liberoReplacements[team].filter(function(r) {
      return r.libero !== sel.libero;
    });
  }
  
  saveActionToHistory({
    type: 'libero',
    team: team,
    libero: sel.libero,
    originalPlayer: sel.playerOut,
    position: posIndex + 1,
    setNumber: gameData.currentSet
  });
  
  gameData.liberoReplacements[team].push({
    libero: sel.libero,
    originalPlayer: sel.playerOut,
    position: posIndex + 1,
    setNumber: gameData.currentSet
  });
  
  gameData.teams[team].lineup[posIndex] = sel.libero;
  
  closeLiberoModal();
  updateMatchDisplay();
  
  var liberoPlayer = gameData.teams[team].players.find(function(p) { return p.jersey === sel.libero; });
  var outPlayer = gameData.teams[team].players.find(function(p) { return p.jersey === sel.playerOut; });
  
  var posName = posIndex === 0 ? 'P1-RB' : posIndex === 4 ? 'P5-LB' : 'P6-MB';
  alert('‚úì Libero replacement complete!\nOUT: #' + outPlayer.jersey + ' ' + outPlayer.name + '\nIN: LIBERO #' + liberoPlayer.jersey + ' ' + liberoPlayer.name + '\nPosition: ' + posName + ' (Back Row)');
}

function removeLiberoFromCourt(liberoJersey) {
  var team = gameData.liberoSelection.team;
  
  var replacement = gameData.liberoReplacements[team].find(function(r) {
    return r.libero === liberoJersey;
  });
  
  if (!replacement) {
    alert('Error: Libero replacement record not found');
    return;
  }
  
  var posIndex = gameData.teams[team].lineup.indexOf(liberoJersey);
  if (posIndex !== -1) {
    gameData.teams[team].lineup[posIndex] = replacement.originalPlayer;
  }
  
  gameData.liberoReplacements[team] = gameData.liberoReplacements[team].filter(function(r) {
    return r.libero !== liberoJersey;
  });
  
  closeLiberoModal();
  updateMatchDisplay();
  
  alert('Libero removed from court');
}

function closeLiberoModal() {
  document.getElementById('liberoModal').classList.remove('active');
  gameData.liberoSelection = {libero: null, playerOut: null, team: null};
}

function isPlayerReplacedByLibero(team, playerJersey) {
  if (!gameData.liberoReplacements[team]) return false;
  return gameData.liberoReplacements[team].some(function(r) {
    return r.originalPlayer === playerJersey;
  });
}

function getPlayerReplacedByLibero(team, liberoJersey) {
  if (!gameData.liberoReplacements[team]) return null;
  var replacement = gameData.liberoReplacements[team].find(function(r) {
    return r.libero === liberoJersey;
  });
  return replacement ? replacement.originalPlayer : null;
}

function openHistoryModal() {
  populateHistoryModal();
  document.getElementById('historyModal').classList.add('active');
}

function populateHistoryModal() {
  var historyContent = document.getElementById('historyContent');
  if (!historyContent) return;
  
  var html = '';
  
  // Coin Toss Section
  html += '<div style="background:#0f3460;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #ffd700">';
  html += '<h4 style="color:#ffd700;margin-bottom:10px;font-size:16px">ü™ô COIN TOSS</h4>';
  if (gameData.coinToss && gameData.coinToss.winner) {
    var tossWinnerName = gameData.matchInfo['team' + gameData.coinToss.winner + 'Name'];
    var tossChoice = gameData.coinToss.choice === 'serve' ? 'Serve First' : 'Receive First';
    var firstServerName = gameData.matchInfo['team' + gameData.coinToss.firstServer + 'Name'];
    html += '<div style="color:#fff;font-size:13px;line-height:1.8">';
    html += '<div>Winner: <strong style="color:#00d9ff">' + tossWinnerName + '</strong></div>';
    html += '<div>Choice: <strong style="color:#00d9ff">' + tossChoice + '</strong></div>';
    html += '<div>First Server: <strong style="color:#00d9ff">' + firstServerName + '</strong></div>';
    html += '</div>';
  } else {
    html += '<div style="color:#888">No coin toss data</div>';
  }
  html += '</div>';
  
  // Set-by-Set Breakdown
  if (gameData.sets && gameData.sets.length > 0) {
    gameData.sets.forEach(function(set, setIdx) {
      var setNum = setIdx + 1;
      html += '<div style="background:#0f3460;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid ' + (set.winner ? '#00ff00' : '#888') + '">';
      html += '<h4 style="color:#ffd700;margin-bottom:10px;font-size:16px">SET ' + setNum + (set.winner ? ' - Won by ' + gameData.matchInfo['team' + set.winner + 'Name'] : ' - In Progress') + '</h4>';
      
      // Score
      html += '<div style="font-size:24px;font-weight:bold;margin-bottom:10px;color:#fff;text-align:center">';
      html += '<span style="color:#ff6b6b">' + gameData.matchInfo.teamAName + ' ' + set.score.A + '</span>';
      html += ' - ';
      html += '<span style="color:#4ecdc4">' + set.score.B + ' ' + gameData.matchInfo.teamBName + '</span>';
      html += '</div>';
      
      // First Server
      html += '<div style="margin-bottom:10px;padding:8px;background:#1a1a2e;border-radius:4px">';
      html += '<strong style="color:#00d9ff">First Server:</strong> <span style="color:#fff">' + gameData.matchInfo['team' + set.serving + 'Name'] + '</span>';
      html += '</div>';
      
      // Timeouts
      html += '<div style="margin-bottom:10px">';
      html += '<strong style="color:#00d9ff">‚è± TIMEOUTS:</strong>';
      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px">';
      html += '<div style="background:#1a1a2e;padding:8px;border-radius:4px">';
      html += '<div style="color:#ff6b6b;font-weight:bold">' + gameData.matchInfo.teamAName + '</div>';
      html += '<div style="color:#fff">' + (set.timeouts.A ? set.timeouts.A.length : 0) + ' / 2 used</div>';
      if (set.timeouts.A && set.timeouts.A.length > 0) {
        set.timeouts.A.forEach(function(t) {
          html += '<div style="color:#888;font-size:11px;margin-top:3px">at ' + t.score.A + '-' + t.score.B + '</div>';
        });
      }
      html += '</div>';
      html += '<div style="background:#1a1a2e;padding:8px;border-radius:4px">';
      html += '<div style="color:#4ecdc4;font-weight:bold">' + gameData.matchInfo.teamBName + '</div>';
      html += '<div style="color:#fff">' + (set.timeouts.B ? set.timeouts.B.length : 0) + ' / 2 used</div>';
      if (set.timeouts.B && set.timeouts.B.length > 0) {
        set.timeouts.B.forEach(function(t) {
          html += '<div style="color:#888;font-size:11px;margin-top:3px">at ' + t.score.A + '-' + t.score.B + '</div>';
        });
      }
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      // Substitutions
      var subCountA = countCompletedSubstitutions('A', setIdx);
      var subCountB = countCompletedSubstitutions('B', setIdx);
      
      html += '<div style="margin-bottom:10px">';
      html += '<strong style="color:#00d9ff">üë• SUBSTITUTIONS:</strong>';
      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px">';
      html += '<div style="background:#1a1a2e;padding:8px;border-radius:4px">';
      html += '<div style="color:#ff6b6b;font-weight:bold">' + gameData.matchInfo.teamAName + '</div>';
      html += '<div style="color:#fff">' + subCountA + ' / 6 used</div>';
      if (set.substitutions.A && set.substitutions.A.length > 0) {
        set.substitutions.A.forEach(function(s) {
          html += '<div style="color:#ccc;font-size:11px;margin-top:3px">#' + s.playerOut + ' ‚Üí #' + s.playerIn + ' at ' + s.score.A + '-' + s.score.B + '</div>';
        });
      }
      html += '</div>';
      html += '<div style="background:#1a1a2e;padding:8px;border-radius:4px">';
      html += '<div style="color:#4ecdc4;font-weight:bold">' + gameData.matchInfo.teamBName + '</div>';
      html += '<div style="color:#fff">' + subCountB + ' / 6 used</div>';
      if (set.substitutions.B && set.substitutions.B.length > 0) {
        set.substitutions.B.forEach(function(s) {
          html += '<div style="color:#ccc;font-size:11px;margin-top:3px">#' + s.playerOut + ' ‚Üí #' + s.playerIn + ' at ' + s.score.A + '-' + s.score.B + '</div>';
        });
      }
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      // Libero Replacements
      if ((gameData.liberoReplacements.A && gameData.liberoReplacements.A.length > 0) || 
          (gameData.liberoReplacements.B && gameData.liberoReplacements.B.length > 0)) {
        html += '<div style="margin-bottom:10px">';
        html += '<strong style="color:#00d9ff">üîÑ LIBERO REPLACEMENTS:</strong>';
        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px">';
        html += '<div style="background:#1a1a2e;padding:8px;border-radius:4px">';
        html += '<div style="color:#ff6b6b;font-weight:bold">' + gameData.matchInfo.teamAName + '</div>';
        if (gameData.liberoReplacements.A && gameData.liberoReplacements.A.length > 0) {
          gameData.liberoReplacements.A.forEach(function(l) {
            if (l.setNumber === setNum) {
              html += '<div style="color:#ccc;font-size:11px;margin-top:3px">L' + l.libero + ' ‚Üí #' + l.originalPlayer + ' (P' + (l.position + 1) + ')</div>';
            }
          });
        } else {
          html += '<div style="color:#888;font-size:11px">None</div>';
        }
        html += '</div>';
        html += '<div style="background:#1a1a2e;padding:8px;border-radius:4px">';
        html += '<div style="color:#4ecdc4;font-weight:bold">' + gameData.matchInfo.teamBName + '</div>';
        if (gameData.liberoReplacements.B && gameData.liberoReplacements.B.length > 0) {
          gameData.liberoReplacements.B.forEach(function(l) {
            if (l.setNumber === setNum) {
              html += '<div style="color:#ccc;font-size:11px;margin-top:3px">L' + l.libero + ' ‚Üí #' + l.originalPlayer + ' (P' + (l.position + 1) + ')</div>';
            }
          });
        } else {
          html += '<div style="color:#888;font-size:11px">None</div>';
        }
        html += '</div>';
        html += '</div>';
        html += '</div>';
      }
      
      html += '</div>';
    });
  }
  
  // Deciding Set Toss (if applicable)
  if (gameData.decidingSetToss) {
    html += '<div style="background:#0f3460;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #ff6b6b">';
    html += '<h4 style="color:#ff6b6b;margin-bottom:10px;font-size:16px">üéØ DECIDING SET TOSS (Set ' + gameData.decidingSetToss.setNumber + ')</h4>';
    var tossWinnerName = gameData.matchInfo['team' + gameData.decidingSetToss.winner + 'Name'];
    var tossChoice = gameData.decidingSetToss.choice === 'serve' ? 'Serve First' : 'Receive First';
    var firstServerName = gameData.matchInfo['team' + gameData.decidingSetToss.firstServer + 'Name'];
    html += '<div style="color:#fff;font-size:13px;line-height:1.8">';
    html += '<div>Winner: <strong style="color:#00d9ff">' + tossWinnerName + '</strong></div>';
    html += '<div>Choice: <strong style="color:#00d9ff">' + tossChoice + '</strong></div>';
    html += '<div>First Server: <strong style="color:#00d9ff">' + firstServerName + '</strong></div>';
    html += '</div>';
    html += '</div>';
  }
  
  historyContent.innerHTML = html;
}

function endMatch() {
  if (!confirm('‚ö†Ô∏è END MATCH?\n\nAre you sure you want to end the current match?\n\nThis will finalize all data and allow you to export the complete scoresheet.')) {
    return;
  }
  
  var winner = null;
  var setsWonA = gameData.sets.filter(function(s) { return s.winner === 'A'; }).length;
  var setsWonB = gameData.sets.filter(function(s) { return s.winner === 'B'; }).length;
  
  if (setsWonA > setsWonB) {
    winner = 'A';
  } else if (setsWonB > setsWonA) {
    winner = 'B';
  }
  
  var msg = '‚úÖ MATCH ENDED\n\n';
  msg += 'Final Score: ' + setsWonA + '-' + setsWonB + '\n';
  if (winner) {
    msg += 'Winner: ' + gameData.matchInfo['team' + winner + 'Name'] + '\n\n';
  } else {
    msg += 'Match incomplete (no winner)\n\n';
  }
  msg += 'You can now:\n';
  msg += '‚Ä¢ View match data (üíæ Match Data button)\n';
  msg += '‚Ä¢ Download PDF scoresheet\n';
  msg += '‚Ä¢ Export signatures\n';
  
  addSummaryEvent('MATCH END', winner || '-', 'Match concluded - Final score: ' + setsWonA + '-' + setsWonB);
  
  alert(msg);
  
  openMatchDataModal();
}

function closeHistoryModal() {
  document.getElementById('historyModal').classList.remove('active');
}

function exportHistoryPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  var yPos = 20;
  
  // Title
  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.text('MATCH HISTORY REPORT', 105, yPos, { align: 'center' });
  yPos += 10;
  
  // Match Info
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text(gameData.matchInfo.competition + ' | ' + gameData.matchInfo.venue, 105, yPos, { align: 'center' });
  yPos += 5;
  doc.text(gameData.matchInfo.teamAName + ' vs ' + gameData.matchInfo.teamBName, 105, yPos, { align: 'center' });
  yPos += 10;
  
  // Coin Toss
  if (gameData.coinToss && gameData.coinToss.winner) {
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('Coin Toss', 20, yPos);
    yPos += 7;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    var tossWinnerName = gameData.matchInfo['team' + gameData.coinToss.winner + 'Name'];
    var tossChoice = gameData.coinToss.choice === 'serve' ? 'Serve First' : 'Receive First';
    var firstServerName = gameData.matchInfo['team' + gameData.coinToss.firstServer + 'Name'];
    doc.text('Winner: ' + tossWinnerName, 20, yPos);
    yPos += 5;
    doc.text('Choice: ' + tossChoice, 20, yPos);
    yPos += 5;
    doc.text('First Server: ' + firstServerName, 20, yPos);
    yPos += 10;
  }
  
  // Set-by-Set Breakdown
  gameData.sets.forEach(function(set, setIdx) {
    var setNum = setIdx + 1;
    
    if (yPos > 250) {
      doc.addPage();
      yPos = 20;
    }
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('SET ' + setNum + (set.winner ? ' - Won by ' + gameData.matchInfo['team' + set.winner + 'Name'] : ''), 20, yPos);
    yPos += 7;
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.text('Score: ' + gameData.matchInfo.teamAName + ' ' + set.score.A + ' - ' + set.score.B + ' ' + gameData.matchInfo.teamBName, 20, yPos);
    yPos += 5;
    doc.text('First Server: ' + gameData.matchInfo['team' + set.serving + 'Name'], 20, yPos);
    yPos += 8;
    
    // Timeouts Table
    var timeoutData = [];
    var maxTimeouts = Math.max(set.timeouts.A.length, set.timeouts.B.length);
    for (var i = 0; i < maxTimeouts; i++) {
      var toA = set.timeouts.A[i];
      var toB = set.timeouts.B[i];
      timeoutData.push([
        toA ? 'at ' + toA.score.A + '-' + toA.score.B : '-',
        toB ? 'at ' + toB.score.A + '-' + toB.score.B : '-'
      ]);
    }
    
    doc.autoTable({
      head: [['Team A Timeouts (' + set.timeouts.A.length + '/2)', 'Team B Timeouts (' + set.timeouts.B.length + '/2)']],
      body: timeoutData.length > 0 ? timeoutData : [['-', '-']],
      startY: yPos,
      theme: 'grid',
      headStyles: { fillColor: [255, 149, 0] },
      margin: { left: 20, right: 20 }
    });
    
    yPos = doc.lastAutoTable.finalY + 5;
    
    // Substitutions Table  
    var subData = [];
    var maxSubs = Math.max(set.substitutions.A.length, set.substitutions.B.length);
    for (var i = 0; i < maxSubs; i++) {
      var subA = set.substitutions.A[i];
      var subB = set.substitutions.B[i];
      subData.push([
        subA ? '#' + subA.playerOut + '‚Üí#' + subA.playerIn + ' at ' + subA.score.A + '-' + subA.score.B : '-',
        subB ? '#' + subB.playerOut + '‚Üí#' + subB.playerIn + ' at ' + subB.score.A + '-' + subB.score.B : '-'
      ]);
    }
    
    var subCountA = countCompletedSubstitutions('A', setIdx);
    var subCountB = countCompletedSubstitutions('B', setIdx);
    
    doc.autoTable({
      head: [['Team A Subs (' + subCountA + '/6)', 'Team B Subs (' + subCountB + '/6)']],
      body: subData.length > 0 ? subData : [['-', '-']],
      startY: yPos,
      theme: 'grid',
      headStyles: { fillColor: [0, 122, 255] },
      margin: { left: 20, right: 20 }
    });
    
    yPos = doc.lastAutoTable.finalY + 10;
  });
  
  // Deciding Set Toss
  if (gameData.decidingSetToss) {
    if (yPos > 250) {
      doc.addPage();
      yPos = 20;
    }
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(255, 0, 0);
    doc.text('Deciding Set Toss (Set ' + gameData.decidingSetToss.setNumber + ')', 20, yPos);
    doc.setTextColor(0, 0, 0);
    yPos += 7;
    doc.setFont(undefined, 'normal');
    var tossWinnerName = gameData.matchInfo['team' + gameData.decidingSetToss.winner + 'Name'];
    var tossChoice = gameData.decidingSetToss.choice === 'serve' ? 'Serve First' : 'Receive First';
    var firstServerName = gameData.matchInfo['team' + gameData.decidingSetToss.firstServer + 'Name'];
    doc.text('Winner: ' + tossWinnerName, 20, yPos);
    yPos += 5;
    doc.text('Choice: ' + tossChoice, 20, yPos);
    yPos += 5;
    doc.text('First Server: ' + firstServerName, 20, yPos);
    yPos += 10;
  }
  
  // Sanctions
  if (gameData.matchSummary && gameData.matchSummary.length > 0) {
    var sanctions = gameData.matchSummary.filter(function(event) {
      return event.type && (event.type.toUpperCase() === 'SANCTION' || event.type === 'Sanction');
    });
    
    if (sanctions.length > 0) {
      if (yPos > 250) {
        doc.addPage();
        yPos = 20;
      }
      
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(255, 0, 0);
      doc.text('‚ö†Ô∏è SANCTIONS', 20, yPos);
      doc.setTextColor(0, 0, 0);
      yPos += 10;
      
      var sanctionData = [];
      sanctions.forEach(function(s) {
        var scoreText = s.score ? (s.score.A + '-' + s.score.B) : '-';
        sanctionData.push([
          s.time || '-',
          'Set ' + (s.setNumber || gameData.currentSet),
          scoreText,
          s.team ? gameData.matchInfo['team' + s.team + 'Name'] : '-',
          s.description || '-'
        ]);
      });
      
      doc.autoTable({
        head: [['Time', 'Set', 'Score', 'Team', 'Sanction Details']],
        body: sanctionData,
        startY: yPos,
        theme: 'grid',
        headStyles: { fillColor: [255, 0, 0] },
        margin: { left: 20, right: 20 }
      });
    }
  }
  
  // Footer
  doc.setFontSize(8);
  doc.setTextColor(128, 128, 128);
  doc.text('Generated by DC_Volley Scoresheet System', 105, 285, { align: 'center' });
  doc.text('¬© 2026 All Rights Reserved', 105, 290, { align: 'center' });
  
  var filename = 'Match_History_' + gameData.matchInfo.teamAName + '_vs_' + gameData.matchInfo.teamBName + '_' + new Date().toISOString().split('T')[0] + '.pdf';
  doc.save(filename);
  
  alert('‚úÖ Match History exported successfully!');
}

function exportSummaryPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  var yPos = 20;
  
  // Title
  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.text('MATCH SUMMARY REPORT', 105, yPos, { align: 'center' });
  yPos += 10;
  
  // Match Info
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text(gameData.matchInfo.competition + ' | ' + gameData.matchInfo.venue, 105, yPos, { align: 'center' });
  yPos += 5;
  doc.text(gameData.matchInfo.teamAName + ' vs ' + gameData.matchInfo.teamBName, 105, yPos, { align: 'center' });
  yPos += 10;
  
  // Statistics Overview
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('Match Statistics', 20, yPos);
  yPos += 10;
  
  // Count totals across all sets
  var totalTimeoutsA = 0;
  var totalTimeoutsB = 0;
  var totalSubsA = 0;
  var totalSubsB = 0;
  
  gameData.sets.forEach(function(set, idx) {
    totalTimeoutsA += set.timeouts.A ? set.timeouts.A.length : 0;
    totalTimeoutsB += set.timeouts.B ? set.timeouts.B.length : 0;
    totalSubsA += countCompletedSubstitutions('A', idx);
    totalSubsB += countCompletedSubstitutions('B', idx);
  });
  
  doc.autoTable({
    head: [['Category', gameData.matchInfo.teamAName, gameData.matchInfo.teamBName]],
    body: [
      ['Total Timeouts', totalTimeoutsA, totalTimeoutsB],
      ['Total Substitutions', totalSubsA, totalSubsB]
    ],
    startY: yPos,
    theme: 'grid',
    headStyles: { fillColor: [0, 217, 255] },
    margin: { left: 20, right: 20 }
  });
  
  yPos = doc.lastAutoTable.finalY + 15;
  
  // Event Log
  if (gameData.matchSummary && gameData.matchSummary.length > 0) {
    doc.addPage();
    yPos = 20;
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('Complete Event Log', 20, yPos);
    yPos += 10;
    
    var eventData = [];
    gameData.matchSummary.forEach(function(event) {
      var teamName = event.team ? gameData.matchInfo['team' + event.team + 'Name'] : '-';
      eventData.push([
        event.time || '-',
        'Set ' + (event.setNumber || '-'),
        event.type || '-',
        teamName,
        event.description || '-'
      ]);
    });
    
    doc.autoTable({
      head: [['Time', 'Set', 'Type', 'Team', 'Details']],
      body: eventData,
      startY: yPos,
      theme: 'grid',
      headStyles: { fillColor: [255, 215, 0] },
      styles: { fontSize: 8 },
      margin: { left: 10, right: 10 }
    });
  }
  
  // Sanctions Summary
  if (gameData.matchSummary && gameData.matchSummary.length > 0) {
    var sanctions = gameData.matchSummary.filter(function(event) {
      return event.type && (event.type.toUpperCase() === 'SANCTION' || event.type === 'Sanction');
    });
    
    if (sanctions.length > 0) {
      doc.addPage();
      yPos = 20;
      
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(255, 0, 0);
      doc.text('‚ö†Ô∏è SANCTIONS SUMMARY', 20, yPos);
      doc.setTextColor(0, 0, 0);
      yPos += 10;
      
      var sanctionData = [];
      sanctions.forEach(function(s) {
        var scoreText = s.score ? (s.score.A + '-' + s.score.B) : '-';
        sanctionData.push([
          s.time || '-',
          'Set ' + (s.setNumber || gameData.currentSet),
          scoreText,
          s.team ? gameData.matchInfo['team' + s.team + 'Name'] : '-',
          s.description || '-'
        ]);
      });
      
      doc.autoTable({
        head: [['Time', 'Set', 'Score', 'Team', 'Sanction Details']],
        body: sanctionData,
        startY: yPos,
        theme: 'grid',
        headStyles: { fillColor: [255, 0, 0] },
        margin: { left: 20, right: 20 }
      });
    }
  }
  
  // Footer
  doc.setFontSize(8);
  doc.setTextColor(128, 128, 128);
  var pageCount = doc.internal.getNumberOfPages();
  for (var i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.text('Page ' + i + ' of ' + pageCount, 105, 290, { align: 'center' });
    doc.text('Generated by DC_Volley Scoresheet System ¬© 2026', 105, 285, { align: 'center' });
  }
  
  var filename = 'Match_Summary_' + gameData.matchInfo.teamAName + '_vs_' + gameData.matchInfo.teamBName + '_' + new Date().toISOString().split('T')[0] + '.pdf';
  doc.save(filename);
  
  alert('‚úÖ Match Summary exported successfully!');
}

function openMatchDataModal() {
  populateMatchDataModal();
  document.getElementById('matchDataModal').classList.add('active');
}

function closeMatchDataModal() {
  document.getElementById('matchDataModal').classList.remove('active');
}

function openSummaryModal() {
  populateSummaryTable();
  document.getElementById('summaryModal').classList.add('active');
}

function closeSummaryModal() {
  document.getElementById('summaryModal').classList.remove('active');
}

function populateSummaryTable() {
  var teamAName = gameData.matchInfo.teamAName || 'Team A';
  var teamBName = gameData.matchInfo.teamBName || 'Team B';
  var teamAColor = gameData.matchInfo.teamAColor || '#ff6b6b';
  var teamBColor = gameData.matchInfo.teamBColor || '#4ecdc4';
  
  // Calculate total timeouts
  var totalTimeoutsA = 0;
  var totalTimeoutsB = 0;
  gameData.sets.forEach(function(set) {
    if (set.timeouts) {
      totalTimeoutsA += (set.timeouts.A || []).length;
      totalTimeoutsB += (set.timeouts.B || []).length;
    }
  });
  
  document.getElementById('summaryTimeouts').innerHTML = 
    '<div style="color:' + teamAColor + '">' + teamAName + ': ' + totalTimeoutsA + ' / 2 per set</div>' +
    '<div style="color:' + teamBColor + '">' + teamBName + ': ' + totalTimeoutsB + ' / 2 per set</div>';
  
  // Calculate total substitutions
  var totalSubsA = 0;
  var totalSubsB = 0;
  gameData.sets.forEach(function(set) {
    if (set.substitutions) {
      totalSubsA += (set.substitutions.A || []).length;
      totalSubsB += (set.substitutions.B || []).length;
    }
  });
  
  document.getElementById('summarySubstitutions').innerHTML = 
    '<div style="color:' + teamAColor + '">' + teamAName + ': ' + totalSubsA + ' / 6 per set</div>' +
    '<div style="color:' + teamBColor + '">' + teamBName + ': ' + totalSubsB + ' / 6 per set</div>';
  
  // Sanctions (placeholder - can be implemented later)
  var sanctionsA = gameData.sanctionsA || 0;
  var sanctionsB = gameData.sanctionsB || 0;
  
  document.getElementById('summarySanctions').innerHTML = 
    '<div style="color:' + teamAColor + '">' + teamAName + ': ' + sanctionsA + '</div>' +
    '<div style="color:' + teamBColor + '">' + teamBName + ': ' + sanctionsB + '</div>';
  
  // Calculate match duration (adds 10 minutes)
  if (gameData.startTime) {
    var now = Date.now();
    var duration = now - gameData.startTime;
    // Add 10 minutes (600000 milliseconds)
    duration += 600000;
    
    var hours = Math.floor(duration / 3600000);
    var minutes = Math.floor((duration % 3600000) / 60000);
    var seconds = Math.floor((duration % 60000) / 1000);
    var durationStr = 
      (hours < 10 ? '0' : '') + hours + ':' +
      (minutes < 10 ? '0' : '') + minutes + ':' +
      (seconds < 10 ? '0' : '') + seconds;
    document.getElementById('totalDuration').textContent = durationStr;
  } else {
    document.getElementById('totalDuration').textContent = 'Not started';
  }
  
  // Generate set-by-set breakdown
  var setBreakdownHTML = '';
  gameData.sets.forEach(function(set, index) {
    var setNum = index + 1;
    var setDuration = '--:--';
    
    if (set.startTime && set.endTime) {
      var dur = set.endTime - set.startTime;
      var mins = Math.floor(dur / 60000);
      var secs = Math.floor((dur % 60000) / 1000);
      setDuration = mins + ':' + (secs < 10 ? '0' : '') + secs;
    } else if (set.startTime) {
      setDuration = 'In progress';
    }
    
    var winnerText = set.winner ? 
      (set.winner === 'A' ? '<span style="color:' + teamAColor + '">' + teamAName + ' wins</span>' : 
       '<span style="color:' + teamBColor + '">' + teamBName + ' wins</span>') : 
      'In progress';
    
    var scoreStyle = 'font-size:24px;font-weight:bold;margin:5px 0';
    var scoreA = '<span style="color:' + teamAColor + '">' + set.score.A + '</span>';
    var scoreB = '<span style="color:' + teamBColor + '">' + set.score.B + '</span>';
    
    var timeoutsA = (set.timeouts && set.timeouts.A) ? set.timeouts.A.length : 0;
    var timeoutsB = (set.timeouts && set.timeouts.B) ? set.timeouts.B.length : 0;
    var subsA = (set.substitutions && set.substitutions.A) ? set.substitutions.A.length : 0;
    var subsB = (set.substitutions && set.substitutions.B) ? set.substitutions.B.length : 0;
    
    setBreakdownHTML += '<div style="background:#0f3460;padding:15px;border-radius:8px;border:2px solid #533483;margin-bottom:10px">';
    setBreakdownHTML += '<div style="display:grid;grid-template-columns:1fr auto 1fr;gap:15px;align-items:center">';
    
    // Left: Set info
    setBreakdownHTML += '<div>';
    setBreakdownHTML += '<h4 style="color:#ffd700;font-size:16px;margin-bottom:8px">SET ' + setNum + '</h4>';
    setBreakdownHTML += '<div style="color:#fff;font-size:13px">';
    setBreakdownHTML += '<div>‚è∞ Duration: ' + setDuration + '</div>';
    setBreakdownHTML += '<div>üèÜ ' + winnerText + '</div>';
    setBreakdownHTML += '</div>';
    setBreakdownHTML += '</div>';
    
    // Center: Score
    setBreakdownHTML += '<div style="text-align:center">';
    setBreakdownHTML += '<div style="' + scoreStyle + '">' + scoreA + ' - ' + scoreB + '</div>';
    setBreakdownHTML += '</div>';
    
    // Right: Stats
    setBreakdownHTML += '<div style="text-align:right">';
    setBreakdownHTML += '<div style="color:#fff;font-size:13px">';
    setBreakdownHTML += '<div>‚è± TO: <span style="color:' + teamAColor + '">' + timeoutsA + '</span> / <span style="color:' + teamBColor + '">' + timeoutsB + '</span></div>';
    setBreakdownHTML += '<div>üë• SUB: <span style="color:' + teamAColor + '">' + subsA + '</span> / <span style="color:' + teamBColor + '">' + subsB + '</span></div>';
    setBreakdownHTML += '</div>';
    setBreakdownHTML += '</div>';
    
    setBreakdownHTML += '</div>';
    setBreakdownHTML += '</div>';
  });
  
  document.getElementById('setBreakdownContainer').innerHTML = setBreakdownHTML || '<div style="color:#888;text-align:center;padding:20px">No sets completed yet</div>';
  
  // Populate event log
  if (!gameData.matchSummary || gameData.matchSummary.length === 0) {
    document.getElementById('summaryTableBody').innerHTML = '<tr><td colspan="5" style="padding:20px;text-align:center;color:#888">No events yet. Start the match to see live updates.</td></tr>';
    return;
  }
  
  var html = '';
  gameData.matchSummary.forEach(function(event) {
    var teamColor = event.team === 'A' ? teamAColor : teamBColor;
    var teamName = event.team === 'A' ? teamAName : teamBName;
    
    html += '<tr style="border-bottom:1px solid #533483">';
    html += '<td style="padding:10px">' + event.set + '</td>';
    html += '<td style="padding:10px">' + event.time + '</td>';
    html += '<td style="padding:10px;color:' + teamColor + ';font-weight:bold">' + teamName + '</td>';
    html += '<td style="padding:10px">' + event.eventType + '</td>';
    html += '<td style="padding:10px">' + event.details + '</td>';
    html += '</tr>';
  });
  
  document.getElementById('summaryTableBody').innerHTML = html;
}

function addSummaryEvent(eventType, team, details, score) {
  if (!gameData.matchSummary) {
    gameData.matchSummary = [];
  }
  
  var now = new Date();
  var timeStr = now.toTimeString().substring(0, 8);
  
  var event = {
    setNumber: gameData.currentSet,
    time: timeStr,
    team: team,
    type: eventType,
    description: details
  };
  
  // Add score if provided
  if (score) {
    event.score = score;
  }
  
  gameData.matchSummary.push(event);
}

function openOfficialsModal() {
  populateOfficialsModal();
  initializeSignaturePads();
  document.getElementById('officialsModal').classList.add('active');
}

function closeOfficialsModal() {
  document.getElementById('officialsModal').classList.remove('active');
}

function populateOfficialsModal() {
  // Set team names in headers and inputs
  document.getElementById('officialsTeamATitle').textContent = gameData.matchInfo.teamAName;
  document.getElementById('officialsTeamBTitle').textContent = gameData.matchInfo.teamBName;
  document.getElementById('teamANameInput').value = gameData.matchInfo.teamAName || '';
  document.getElementById('teamBNameInput').value = gameData.matchInfo.teamBName || '';
  
  // Display match officials names from matchInfo
  document.getElementById('ref1Display').textContent = gameData.matchInfo.ref1 || '-';
  document.getElementById('ref2Display').textContent = gameData.matchInfo.ref2 || '-';
  document.getElementById('scorerDisplay').textContent = gameData.matchInfo.scorer || '-';
  document.getElementById('assistScorerDisplay').textContent = gameData.matchInfo.assistScorer || '-';
  
  // Load saved data if exists
  if (gameData.officials) {
    document.getElementById('coachA').value = gameData.officials.coachA || '';
    document.getElementById('asstCoachA').value = gameData.officials.asstCoachA || '';
    document.getElementById('medicalA').value = gameData.officials.medicalA || '';
    document.getElementById('trainerA').value = gameData.officials.trainerA || '';
    
    document.getElementById('coachB').value = gameData.officials.coachB || '';
    document.getElementById('asstCoachB').value = gameData.officials.asstCoachB || '';
    document.getElementById('medicalB').value = gameData.officials.medicalB || '';
    document.getElementById('trainerB').value = gameData.officials.trainerB || '';
  }
}

function saveOfficials() {
  // Update team names in matchInfo
  var teamAName = document.getElementById('teamANameInput').value.trim();
  var teamBName = document.getElementById('teamBNameInput').value.trim();
  
  if (teamAName) {
    gameData.matchInfo.teamAName = teamAName;
  }
  if (teamBName) {
    gameData.matchInfo.teamBName = teamBName;
  }
  
  // Update all displays with new team names
  document.getElementById('courtNameA').textContent = gameData.matchInfo.teamAName;
  document.getElementById('courtNameB').textContent = gameData.matchInfo.teamBName;
  document.getElementById('sideATtl').textContent = gameData.matchInfo.teamAName + ' LINEUP';
  document.getElementById('sideBTtl').textContent = gameData.matchInfo.teamBName + ' LINEUP';
  
  gameData.officials = {
    coachA: document.getElementById('coachA').value,
    asstCoachA: document.getElementById('asstCoachA').value,
    medicalA: document.getElementById('medicalA').value,
    trainerA: document.getElementById('trainerA').value,
    coachB: document.getElementById('coachB').value,
    asstCoachB: document.getElementById('asstCoachB').value,
    medicalB: document.getElementById('medicalB').value,
    trainerB: document.getElementById('trainerB').value,
    signatures: {
      captainSignA1: document.getElementById('captainSignA1').toDataURL(),
      captainSignA2: document.getElementById('captainSignA2').toDataURL(),
      coachSignA: document.getElementById('coachSignA').toDataURL(),
      captainSignB1: document.getElementById('captainSignB1').toDataURL(),
      captainSignB2: document.getElementById('captainSignB2').toDataURL(),
      coachSignB: document.getElementById('coachSignB').toDataURL(),
      firstRefSign: document.getElementById('firstRefSign').toDataURL(),
      secondRefSign: document.getElementById('secondRefSign').toDataURL(),
      scorerSign: document.getElementById('scorerSign').toDataURL(),
      assistScorerSign: document.getElementById('assistScorerSign').toDataURL()
    }
  };
  
  updateMatchDisplay();
  
  alert('‚úÖ Officials and signatures saved successfully!');
}

var signaturePads = {};

function initializeSignaturePads() {
  var canvasIds = ['captainSignA1', 'captainSignA2', 'coachSignA', 'captainSignB1', 'captainSignB2', 'coachSignB', 'firstRefSign', 'secondRefSign', 'scorerSign', 'assistScorerSign'];
  
  canvasIds.forEach(function(id) {
    var canvas = document.getElementById(id);
    var ctx = canvas.getContext('2d');
    
    // Load saved signature if exists
    if (gameData.officials && gameData.officials.signatures && gameData.officials.signatures[id]) {
      var img = new Image();
      img.onload = function() {
        ctx.drawImage(img, 0, 0);
      };
      img.src = gameData.officials.signatures[id];
    }
    
    var drawing = false;
    
    canvas.addEventListener('mousedown', function(e) {
      drawing = true;
      ctx.beginPath();
      var rect = canvas.getBoundingClientRect();
      ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    });
    
    canvas.addEventListener('mousemove', function(e) {
      if (!drawing) return;
      var rect = canvas.getBoundingClientRect();
      ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.stroke();
    });
    
    canvas.addEventListener('mouseup', function() {
      drawing = false;
    });
    
    canvas.addEventListener('mouseleave', function() {
      drawing = false;
    });
    
    // Touch support
    canvas.addEventListener('touchstart', function(e) {
      e.preventDefault();
      drawing = true;
      ctx.beginPath();
      var rect = canvas.getBoundingClientRect();
      var touch = e.touches[0];
      ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
    });
    
    canvas.addEventListener('touchmove', function(e) {
      e.preventDefault();
      if (!drawing) return;
      var rect = canvas.getBoundingClientRect();
      var touch = e.touches[0];
      ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 2;
      ctx.stroke();
    });
    
    canvas.addEventListener('touchend', function(e) {
      e.preventDefault();
      drawing = false;
    });
  });
}

function clearSignature(canvasId) {
  var canvas = document.getElementById(canvasId);
  var ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

var selectedSanctionTeam = null;

function openSanctionModal() {
  selectedSanctionTeam = null;
  document.getElementById('sanctionTeamA').style.borderColor = '#533483';
  document.getElementById('sanctionTeamB').style.borderColor = '#533483';
  document.getElementById('sanctionTeamAName').textContent = gameData.matchInfo.teamAName || 'Team A';
  document.getElementById('sanctionTeamBName').textContent = gameData.matchInfo.teamBName || 'Team B';
  document.getElementById('sanctionType').value = '';
  document.getElementById('sanctionPlayer').value = '';
  document.getElementById('sanctionNotes').value = '';
  document.getElementById('sanctionModal').classList.add('active');
}

function closeSanctionModal() {
  document.getElementById('sanctionModal').classList.remove('active');
}

function selectSanctionTeam(team) {
  selectedSanctionTeam = team;
  var colorA = gameData.matchInfo.teamAColor || '#ff6b6b';
  var colorB = gameData.matchInfo.teamBColor || '#4ecdc4';
  
  if (team === 'A') {
    document.getElementById('sanctionTeamA').style.borderColor = colorA;
    document.getElementById('sanctionTeamA').style.borderWidth = '3px';
    document.getElementById('sanctionTeamB').style.borderColor = '#533483';
    document.getElementById('sanctionTeamB').style.borderWidth = '2px';
  } else {
    document.getElementById('sanctionTeamB').style.borderColor = colorB;
    document.getElementById('sanctionTeamB').style.borderWidth = '3px';
    document.getElementById('sanctionTeamA').style.borderColor = '#533483';
    document.getElementById('sanctionTeamA').style.borderWidth = '2px';
  }
}

function recordSanction() {
  if (!selectedSanctionTeam) {
    alert('Please select a team');
    return;
  }
  
  var type = document.getElementById('sanctionType').value;
  if (!type) {
    alert('Please select sanction type');
    return;
  }
  
  var player = document.getElementById('sanctionPlayer').value.trim();
  var notes = document.getElementById('sanctionNotes').value.trim();
  
  if (!gameData.sanctions) {
    gameData.sanctions = {A: [], B: []};
  }
  
  if (!gameData.sanctionsA) gameData.sanctionsA = 0;
  if (!gameData.sanctionsB) gameData.sanctionsB = 0;
  
  var sanction = {
    set: gameData.currentSet,
    time: new Date().toTimeString().substring(0, 8),
    type: type,
    player: player || 'Team',
    notes: notes,
    score: {
      A: gameData.sets[gameData.currentSet - 1].score.A,
      B: gameData.sets[gameData.currentSet - 1].score.B
    }
  };
  
  gameData.sanctions[selectedSanctionTeam].push(sanction);
  
  if (selectedSanctionTeam === 'A') {
    gameData.sanctionsA++;
  } else {
    gameData.sanctionsB++;
  }
  
  // Add to match summary
  var typeNames = {
    'delay': 'Delay Warning',
    'delay_penalty': 'Delay Penalty',
    'misconduct_warning': 'Yellow Card',
    'misconduct_penalty': 'Red Card',
    'misconduct_expulsion': 'Expulsion',
    'misconduct_disqualification': 'Disqualification'
  };
  
  var currentScore = {
    A: gameData.sets[gameData.currentSet - 1].score.A,
    B: gameData.sets[gameData.currentSet - 1].score.B
  };
  
  var details = typeNames[type] + (player ? ' - #' + player : '') + (notes ? ' (' + notes + ')' : '');
  addSummaryEvent('SANCTION', selectedSanctionTeam, details, currentScore);
  
  alert('‚úÖ Sanction recorded: ' + typeNames[type]);
  closeSanctionModal();
}



function populateMatchDataModal() {
  // Match Information
  var infoHTML = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">';
  infoHTML += '<div><strong>Competition:</strong> ' + gameData.matchInfo.competition + '</div>';
  infoHTML += '<div><strong>Match Number:</strong> ' + gameData.matchInfo.matchNumber + '</div>';
  infoHTML += '<div><strong>Venue:</strong> ' + gameData.matchInfo.venue + '</div>';
  infoHTML += '<div><strong>Date:</strong> ' + gameData.matchInfo.date + '</div>';
  infoHTML += '<div><strong>Time:</strong> ' + gameData.matchInfo.time + '</div>';
  infoHTML += '<div><strong>Format:</strong> Best of ' + gameData.matchInfo.format + '</div>';
  infoHTML += '<div><strong>1st Referee:</strong> ' + gameData.matchInfo.ref1 + '</div>';
  infoHTML += '<div><strong>2nd Referee:</strong> ' + gameData.matchInfo.ref2 + '</div>';
  infoHTML += '<div><strong>Scorer:</strong> ' + gameData.matchInfo.scorer + '</div>';
  infoHTML += '<div><strong>Assistant Scorer:</strong> ' + gameData.matchInfo.assistScorer + '</div>';
  infoHTML += '</div>';
  
  // Coin Toss Information
  if (gameData.coinToss && gameData.coinToss.winner) {
    infoHTML += '<div style="background:#1a1a2e;padding:12px;border-radius:6px;margin-top:15px;border-left:3px solid #ffd700">';
    infoHTML += '<div style="font-size:14px;font-weight:bold;color:#ffd700;margin-bottom:8px">ü™ô Coin Toss</div>';
    var tossWinnerName = gameData.matchInfo['team' + gameData.coinToss.winner + 'Name'];
    var tossChoice = gameData.coinToss.choice === 'serve' ? 'Serve First' : 'Receive First';
    var firstServerName = gameData.matchInfo['team' + gameData.coinToss.firstServer + 'Name'];
    infoHTML += '<div style="font-size:12px;margin-bottom:4px"><strong>Winner:</strong> ' + tossWinnerName + '</div>';
    infoHTML += '<div style="font-size:12px;margin-bottom:4px"><strong>Choice:</strong> ' + tossChoice + '</div>';
    infoHTML += '<div style="font-size:12px"><strong>First Server:</strong> ' + firstServerName + '</div>';
    infoHTML += '</div>';
  }
  
  document.getElementById('matchDataInfo').innerHTML = infoHTML;
  
  // Team A Data
  var teamAHTML = '<div style="margin-bottom:10px"><strong>' + gameData.matchInfo.teamAName + '</strong></div>';
  teamAHTML += '<div style="color:#888;font-size:11px;margin-bottom:8px">Players:</div>';
  gameData.teams.A.players.forEach(function(p) {
    var role = '';
    if (p.role === 'captain') role = ' <span style="color:#ffd700">(Captain)</span>';
    else if (p.role === 'libero1') role = ' <span style="color:#9c27b0">(Libero 1)</span>';
    else if (p.role === 'libero2') role = ' <span style="color:#9c27b0">(Libero 2)</span>';
    teamAHTML += '<div style="padding:4px 0">#' + p.jersey + ' - ' + p.name + role + '</div>';
  });
  document.getElementById('teamAData').innerHTML = teamAHTML;
  
  // Team B Data
  var teamBHTML = '<div style="margin-bottom:10px"><strong>' + gameData.matchInfo.teamBName + '</strong></div>';
  teamBHTML += '<div style="color:#888;font-size:11px;margin-bottom:8px">Players:</div>';
  gameData.teams.B.players.forEach(function(p) {
    var role = '';
    if (p.role === 'captain') role = ' <span style="color:#ffd700">(Captain)</span>';
    else if (p.role === 'libero1') role = ' <span style="color:#9c27b0">(Libero 1)</span>';
    else if (p.role === 'libero2') role = ' <span style="color:#9c27b0">(Libero 2)</span>';
    teamBHTML += '<div style="padding:4px 0">#' + p.jersey + ' - ' + p.name + role + '</div>';
  });
  document.getElementById('teamBData').innerHTML = teamBHTML;
  
  // Sets Data
  var setsHTML = '';
  var totalPointsA = 0;
  var totalPointsB = 0;
  var pointsBreakdownA = [];
  var pointsBreakdownB = [];
  
  gameData.sets.forEach(function(set, idx) {
    var setNum = idx + 1;
    var scoreA = set.score.A || 0;
    var scoreB = set.score.B || 0;
    totalPointsA += scoreA;
    totalPointsB += scoreB;
    pointsBreakdownA.push(scoreA);
    pointsBreakdownB.push(scoreB);
    
    setsHTML += '<div style="background:#1a1a2e;padding:15px;border-radius:6px;margin-bottom:10px;border-left:4px solid ' + (set.winner ? '#00ff00' : '#888') + '">';
    setsHTML += '<div style="font-size:16px;font-weight:bold;margin-bottom:10px;color:#ffd700">SET ' + setNum + '</div>';
    setsHTML += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">';
    setsHTML += '<div><strong>Score:</strong> ' + gameData.matchInfo.teamAName + ' ' + set.score.A + ' - ' + set.score.B + ' ' + gameData.matchInfo.teamBName + '</div>';
    setsHTML += '<div><strong>Winner:</strong> ' + (set.winner ? gameData.matchInfo['team' + set.winner + 'Name'] : 'In Progress') + '</div>';
    setsHTML += '<div><strong>First Server:</strong> ' + gameData.matchInfo['team' + set.serving + 'Name'] + '</div>';
    setsHTML += '<div><strong>Timeouts A:</strong> ' + set.timeouts.A.length + ' | <strong>B:</strong> ' + set.timeouts.B.length + '</div>';
    setsHTML += '<div><strong>Substitutions A:</strong> ' + set.substitutions.A.length + ' | <strong>B:</strong> ' + set.substitutions.B.length + '</div>';
    setsHTML += '</div>';
    setsHTML += '</div>';
  });
  
  // Add Total Points Summary with calculation breakdown
  setsHTML += '<div style="background:#0f3460;padding:15px;border-radius:6px;margin-top:15px;border:2px solid #ffd700">';
  setsHTML += '<div style="font-size:16px;font-weight:bold;margin-bottom:10px;color:#ffd700">üìä TOTAL POINTS CALCULATION</div>';
  setsHTML += '<div style="font-size:14px;margin-bottom:8px">';
  setsHTML += '<strong style="color:#ff6b6b">' + gameData.matchInfo.teamAName + ':</strong> ';
  setsHTML += '<span style="color:#fff">' + pointsBreakdownA.join(' + ') + ' = <strong style="color:#ffd700;font-size:18px">' + totalPointsA + '</strong></span>';
  setsHTML += '</div>';
  setsHTML += '<div style="font-size:14px">';
  setsHTML += '<strong style="color:#4ecdc4">' + gameData.matchInfo.teamBName + ':</strong> ';
  setsHTML += '<span style="color:#fff">' + pointsBreakdownB.join(' + ') + ' = <strong style="color:#ffd700;font-size:18px">' + totalPointsB + '</strong></span>';
  setsHTML += '</div>';
  setsHTML += '</div>';
  
  // Add Sanctions Summary (if any)
  if (gameData.matchSummary && gameData.matchSummary.length > 0) {
    var sanctions = gameData.matchSummary.filter(function(event) {
      return event.type && (event.type.toUpperCase() === 'SANCTION' || event.type === 'Sanction');
    });
    
    if (sanctions.length > 0) {
      setsHTML += '<div style="background:#1a1a2e;padding:15px;border-radius:6px;margin-top:15px;border:2px solid #ff0000">';
      setsHTML += '<div style="font-size:16px;font-weight:bold;margin-bottom:10px;color:#ff0000">‚ö†Ô∏è SANCTIONS (' + sanctions.length + ')</div>';
      sanctions.forEach(function(s) {
        setsHTML += '<div style="background:#16213e;padding:10px;margin-bottom:8px;border-radius:4px;border-left:3px solid #ff0000">';
        setsHTML += '<div style="color:#ffd700;font-size:11px;margin-bottom:4px">' + (s.time || '-') + ' | Set ' + (s.setNumber || gameData.currentSet);
        if (s.score) {
          setsHTML += ' | Score: ' + s.score.A + '-' + s.score.B;
        }
        setsHTML += '</div>';
        setsHTML += '<div><strong style="color:#ff6b6b">' + (s.team ? gameData.matchInfo['team' + s.team + 'Name'] : '-') + '</strong></div>';
        setsHTML += '<div style="color:#ccc;font-size:13px;margin-top:4px">' + (s.description || '-') + '</div>';
        setsHTML += '</div>';
      });
      setsHTML += '</div>';
    }
  }
  
  document.getElementById('setsData').innerHTML = setsHTML;
}

function downloadMatchDataPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  var yPos = 20;
  
  // Title
  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.text('COMPLETE MATCH LOG & SCORESHEET', 105, yPos, { align: 'center' });
  yPos += 10;
  
  // Match Information
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('Match Information', 20, yPos);
  yPos += 7;
  
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text('Competition: ' + (gameData.matchInfo.competition || 'N/A'), 20, yPos);
  yPos += 5;
  doc.text('Venue: ' + (gameData.matchInfo.venue || 'N/A'), 20, yPos);
  yPos += 5;
  doc.text('Date: ' + (gameData.matchInfo.matchDate || 'N/A') + ' | Time: ' + (gameData.matchInfo.matchTime || 'N/A'), 20, yPos);
  yPos += 5;
  doc.text('Format: Best of ' + gameData.matchInfo.format, 20, yPos);
  yPos += 10;
  
  // Teams
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('Teams', 20, yPos);
  yPos += 7;
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text(gameData.matchInfo.teamAName + ' vs ' + gameData.matchInfo.teamBName, 20, yPos);
  yPos += 10;
  
  // Coin Toss Information
  if (gameData.coinToss && gameData.coinToss.winner) {
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('Coin Toss', 20, yPos);
    yPos += 7;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    var tossWinnerName = gameData.matchInfo['team' + gameData.coinToss.winner + 'Name'];
    var tossChoice = gameData.coinToss.choice === 'serve' ? 'Serve First' : 'Receive First';
    var firstServerName = gameData.matchInfo['team' + gameData.coinToss.firstServer + 'Name'];
    doc.text('Toss Winner: ' + tossWinnerName, 20, yPos);
    yPos += 5;
    doc.text('Choice: ' + tossChoice, 20, yPos);
    yPos += 5;
    doc.text('First Server: ' + firstServerName, 20, yPos);
    yPos += 10;
  }
  
  // Officials
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('Match Officials', 20, yPos);
  yPos += 7;
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text('1st Referee: ' + (gameData.matchInfo.ref1 || 'N/A'), 20, yPos);
  yPos += 5;
  doc.text('2nd Referee: ' + (gameData.matchInfo.ref2 || 'N/A'), 20, yPos);
  yPos += 5;
  doc.text('Scorer: ' + (gameData.matchInfo.scorer || 'N/A'), 20, yPos);
  yPos += 5;
  if (gameData.matchInfo.assistScorer) {
    doc.text('Assistant Scorer: ' + gameData.matchInfo.assistScorer, 20, yPos);
    yPos += 5;
  }
  yPos += 5;
  
  // Final Score
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('Final Score', 20, yPos);
  yPos += 7;
  
  var setsWonA = gameData.sets.filter(function(s) { return s.winner === 'A'; }).length;
  var setsWonB = gameData.sets.filter(function(s) { return s.winner === 'B'; }).length;
  
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text(gameData.matchInfo.teamAName + ': ' + setsWonA + ' sets', 20, yPos);
  yPos += 5;
  doc.text(gameData.matchInfo.teamBName + ': ' + setsWonB + ' sets', 20, yPos);
  yPos += 10;
  
  // Set Scores Table
  var setScores = [];
  gameData.sets.forEach(function(set, idx) {
    setScores.push([
      'Set ' + (idx + 1),
      set.score.A,
      set.score.B,
      set.winner === 'A' ? gameData.matchInfo.teamAName : (set.winner === 'B' ? gameData.matchInfo.teamBName : '-')
    ]);
  });
  
  doc.autoTable({
    head: [['Set', gameData.matchInfo.teamAName, gameData.matchInfo.teamBName, 'Winner']],
    body: setScores,
    startY: yPos,
    theme: 'grid',
    headStyles: { fillColor: [233, 69, 96] },
    margin: { left: 20, right: 20 }
  });
  
  yPos = doc.lastAutoTable.finalY + 10;
  
  // Calculate Total Points with breakdown
  var totalPointsA = 0;
  var totalPointsB = 0;
  var pointsBreakdownA = [];
  var pointsBreakdownB = [];
  
  gameData.sets.forEach(function(set, idx) {
    var scoreA = set.score.A || 0;
    var scoreB = set.score.B || 0;
    totalPointsA += scoreA;
    totalPointsB += scoreB;
    pointsBreakdownA.push(scoreA);
    pointsBreakdownB.push(scoreB);
  });
  
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  doc.text('Total Points Across All Sets', 20, yPos);
  yPos += 7;
  
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  
  // Team A calculation
  var calcA = pointsBreakdownA.join(' + ') + ' = ' + totalPointsA;
  doc.text(gameData.matchInfo.teamAName + ': ' + calcA, 20, yPos);
  yPos += 5;
  
  // Team B calculation
  var calcB = pointsBreakdownB.join(' + ') + ' = ' + totalPointsB;
  doc.text(gameData.matchInfo.teamBName + ': ' + calcB, 20, yPos);
  yPos += 10;
  
  // NEW PAGE - Match Statistics
  doc.addPage();
  yPos = 20;
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text('MATCH STATISTICS', 20, yPos);
  yPos += 10;
  
  var statsData = [];
  gameData.sets.forEach(function(set, idx) {
    var timeoutsUsedA = set.timeouts.A ? set.timeouts.A.length : 0;
    var timeoutsUsedB = set.timeouts.B ? set.timeouts.B.length : 0;
    var subsUsedA = set.substitutions.A ? set.substitutions.A.length : 0;
    var subsUsedB = set.substitutions.B ? set.substitutions.B.length : 0;
    
    statsData.push([
      'Set ' + (idx + 1),
      timeoutsUsedA + ' / 2',
      timeoutsUsedB + ' / 2',
      subsUsedA + ' / 6',
      subsUsedB + ' / 6'
    ]);
  });
  
  doc.autoTable({
    head: [[
      'Set',
      gameData.matchInfo.teamAName + ' Timeouts',
      gameData.matchInfo.teamBName + ' Timeouts',
      gameData.matchInfo.teamAName + ' Subs',
      gameData.matchInfo.teamBName + ' Subs'
    ]],
    body: statsData,
    startY: yPos,
    theme: 'grid',
    headStyles: { fillColor: [0, 217, 255] },
    margin: { left: 20, right: 20 }
  });
  
  yPos = doc.lastAutoTable.finalY + 15;
  
  // Sanctions (if any)
  if (gameData.matchSummary && gameData.matchSummary.length > 0) {
    var sanctions = gameData.matchSummary.filter(function(event) {
      return event.type && (event.type.toUpperCase() === 'SANCTION' || event.type === 'Sanction');
    });
    
    if (sanctions.length > 0) {
      if (yPos > 250) {
        doc.addPage();
        yPos = 20;
      }
      
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.setTextColor(255, 0, 0);
      doc.text('‚ö†Ô∏è SANCTIONS', 20, yPos);
      doc.setTextColor(0, 0, 0);
      yPos += 10;
      
      var sanctionData = [];
      sanctions.forEach(function(s) {
        var scoreText = s.score ? (s.score.A + '-' + s.score.B) : '-';
        sanctionData.push([
          s.time || '-',
          'Set ' + (s.setNumber || gameData.currentSet),
          scoreText,
          s.team ? gameData.matchInfo['team' + s.team + 'Name'] : '-',
          s.description || '-'
        ]);
      });
      
      doc.autoTable({
        head: [['Time', 'Set', 'Score', 'Team', 'Sanction']],
        body: sanctionData,
        startY: yPos,
        theme: 'grid',
        headStyles: { fillColor: [255, 69, 96] },
        margin: { left: 20, right: 20 }
      });
      
      yPos = doc.lastAutoTable.finalY + 10;
    }
  }
  
  // NEW PAGE - Complete Action History / Match Log
  doc.addPage();
  yPos = 20;
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text('COMPLETE MATCH LOG', 20, yPos);
  yPos += 10;
  
  if (gameData.matchSummary && gameData.matchSummary.length > 0) {
    var logData = [];
    gameData.matchSummary.forEach(function(event) {
      var teamName = event.team ? gameData.matchInfo['team' + event.team + 'Name'] : '-';
      logData.push([
        event.time || '-',
        'Set ' + (event.setNumber || gameData.currentSet),
        event.type || '-',
        teamName,
        event.description || '-'
      ]);
    });
    
    doc.autoTable({
      head: [['Time', 'Set', 'Event', 'Team', 'Details']],
      body: logData,
      startY: yPos,
      theme: 'striped',
      headStyles: { fillColor: [83, 52, 131] },
      margin: { left: 20, right: 20 },
      styles: { fontSize: 8, cellPadding: 2 }
    });
    
    yPos = doc.lastAutoTable.finalY + 10;
  } else {
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text('No match events recorded.', 20, yPos);
  }
  
  // Copyright footer on last page
  var pageCount = doc.internal.getNumberOfPages();
  doc.setPage(pageCount);
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.setTextColor(100, 100, 100);
  doc.text('Generated by DC_Volley ¬© 2025 - Digital Volleyball Scoresheet', 105, 285, { align: 'center' });
  
  // Save PDF
  var fileName = 'Match_Log_' + gameData.matchInfo.teamAName + '_vs_' + gameData.matchInfo.teamBName + '_' + new Date().toISOString().split('T')[0] + '.pdf';
  doc.save(fileName);
  
  alert('‚úÖ Complete match log PDF downloaded successfully!');
}
function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  let y = 20;
  
  // Title
  doc.setFontSize(20);
  doc.setFont(undefined, 'bold');
  doc.text('VOLLEYBALL MATCH REPORT', 105, y, { align: 'center' });
  y += 15;
  
  // Match Info
  doc.setFontSize(12);
  doc.setFont(undefined, 'normal');
  doc.text('Competition: ' + (gameData.matchInfo.competition || 'N/A'), 20, y);
  y += 7;
  if (gameData.matchInfo.venue) {
    doc.text('Venue: ' + gameData.matchInfo.venue, 20, y);
    y += 7;
  }
  doc.text('Date: ' + (gameData.matchInfo.matchDate || 'N/A') + ' | Time: ' + (gameData.matchInfo.matchTime || 'N/A'), 20, y);
  y += 10;
  
  // Officials
  doc.setFontSize(11);
  doc.text('Officials:', 20, y);
  y += 6;
  doc.text('  1st Referee: ' + (gameData.matchInfo.ref1 || 'N/A'), 20, y);
  y += 6;
  doc.text('  2nd Referee: ' + (gameData.matchInfo.ref2 || 'N/A'), 20, y);
  y += 6;
  doc.text('  Scorer: ' + (gameData.matchInfo.scorer || 'N/A'), 20, y);
  y += 6;
  if (gameData.matchInfo.assistScorer) {
    doc.text('  Assistant Scorer: ' + gameData.matchInfo.assistScorer, 20, y);
    y += 6;
  }
  y += 6;
  
  // Teams
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text('TEAMS', 20, y);
  y += 8;
  doc.setFontSize(12);
  doc.setFont(undefined, 'normal');
  doc.text(gameData.matchInfo.teamAName + ' vs ' + gameData.matchInfo.teamBName, 30, y);
  y += 12;
  
  // Final Score
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text('FINAL SCORE', 20, y);
  y += 8;
  doc.setFontSize(12);
  doc.setFont(undefined, 'normal');
  
  var setsWonA = 0, setsWonB = 0;
  gameData.sets.forEach(function(s) {
    if (s.winner === 'A') setsWonA++;
    if (s.winner === 'B') setsWonB++;
  });
  
  doc.text(gameData.matchInfo.teamAName + ': ' + setsWonA + ' sets', 30, y);
  y += 6;
  doc.text(gameData.matchInfo.teamBName + ': ' + setsWonB + ' sets', 30, y);
  y += 10;
  
  // Set Scores Table
  var setScores = [];
  gameData.sets.forEach(function(set, idx) {
    setScores.push([
      'Set ' + (idx + 1),
      set.score.A,
      set.score.B,
      set.winner === 'A' ? gameData.matchInfo.teamAName : (set.winner === 'B' ? gameData.matchInfo.teamBName : '-')
    ]);
  });
  
  doc.autoTable({
    head: [['Set', gameData.matchInfo.teamAName, gameData.matchInfo.teamBName, 'Winner']],
    body: setScores,
    startY: y,
    theme: 'grid',
    headStyles: { fillColor: [233, 69, 96] },
    margin: { left: 20, right: 20 }
  });
  
  y = doc.lastAutoTable.finalY + 12;
  
  // Team Rosters
  doc.addPage();
  y = 20;
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text(gameData.matchInfo.teamAName + ' ROSTER', 20, y);
  y += 10;
  
  var rosterA = [];
  if (gameData.teams.A.players) {
    gameData.teams.A.players.forEach(function(p) {
      var role = 'Player';
      if (p.role === 'libero1') role = 'Libero 1';
      else if (p.role === 'libero2') role = 'Libero 2';
      else if (p.role === 'captain') role = 'Captain';
      
      rosterA.push([
        p.jersey,
        p.name,
        role
      ]);
    });
  }
  
  doc.autoTable({
    head: [['Jersey #', 'Player Name', 'Role']],
    body: rosterA,
    startY: y,
    theme: 'grid',
    headStyles: { fillColor: [83, 52, 131] },
    margin: { left: 20, right: 20 }
  });
  
  y = doc.lastAutoTable.finalY + 12;
  
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text(gameData.matchInfo.teamBName + ' ROSTER', 20, y);
  y += 10;
  
  var rosterB = [];
  if (gameData.teams.B.players) {
    gameData.teams.B.players.forEach(function(p) {
      var role = 'Player';
      if (p.role === 'libero1') role = 'Libero 1';
      else if (p.role === 'libero2') role = 'Libero 2';
      else if (p.role === 'captain') role = 'Captain';
      
      rosterB.push([
        p.jersey,
        p.name,
        role
      ]);
    });
  }
  
  doc.autoTable({
    head: [['Jersey #', 'Player Name', 'Role']],
    body: rosterB,
    startY: y,
    theme: 'grid',
    headStyles: { fillColor: [83, 52, 131] },
    margin: { left: 20, right: 20 }
  });
  
  // Match Stats
  doc.addPage();
  y = 20;
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text('MATCH STATISTICS', 20, y);
  y += 10;
  
  var statsData = [];
  gameData.sets.forEach(function(set) {
    var timeoutsUsedA = set.timeouts.A ? set.timeouts.A.length : 0;
    var timeoutsUsedB = set.timeouts.B ? set.timeouts.B.length : 0;
    var subsUsedA = set.substitutions.A ? set.substitutions.A.length : 0;
    var subsUsedB = set.substitutions.B ? set.substitutions.B.length : 0;
    
    statsData.push([
      'Set ' + set.setNumber || gameData.sets.indexOf(set) + 1,
      timeoutsUsedA + ' / 2',
      timeoutsUsedB + ' / 2',
      subsUsedA + ' / 6',
      subsUsedB + ' / 6'
    ]);
  });
  
  doc.autoTable({
    head: [[
      'Set',
      gameData.matchInfo.teamAName + ' Timeouts',
      gameData.matchInfo.teamBName + ' Timeouts',
      gameData.matchInfo.teamAName + ' Subs',
      gameData.matchInfo.teamBName + ' Subs'
    ]],
    body: statsData,
    startY: y,
    theme: 'grid',
    headStyles: { fillColor: [0, 217, 255] },
    margin: { left: 20, right: 20 }
  });
  
  // Signatures Page
  if (gameData.officials && gameData.officials.signatures) {
    doc.addPage();
    y = 20;
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text('OFFICIAL SIGNATURES', 105, y, { align: 'center' });
    y += 15;
    
    // Team A Officials
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(255, 107, 107);
    doc.text(gameData.matchInfo.teamAName, 20, y);
    doc.setTextColor(0, 0, 0);
    y += 10;
    
    if (gameData.officials.coachA) {
      doc.setFontSize(11);
      doc.setFont(undefined, 'normal');
      doc.text('Coach: ' + gameData.officials.coachA, 25, y);
      y += 5;
      if (gameData.officials.signatures.coachSignA) {
        doc.addImage(gameData.officials.signatures.coachSignA, 'PNG', 25, y, 50, 10);
      }
      y += 15;
    }
    
    doc.setFontSize(11);
    doc.text('Captain Signature (Before Match):', 25, y);
    y += 5;
    if (gameData.officials.signatures.captainSignA1) {
      doc.addImage(gameData.officials.signatures.captainSignA1, 'PNG', 25, y, 50, 10);
    }
    y += 15;
    
    doc.text('Captain Signature (After Match):', 25, y);
    y += 5;
    if (gameData.officials.signatures.captainSignA2) {
      doc.addImage(gameData.officials.signatures.captainSignA2, 'PNG', 25, y, 50, 10);
    }
    y += 20;
    
    // Team B Officials
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(78, 205, 196);
    doc.text(gameData.matchInfo.teamBName, 20, y);
    doc.setTextColor(0, 0, 0);
    y += 10;
    
    if (gameData.officials.coachB) {
      doc.setFontSize(11);
      doc.setFont(undefined, 'normal');
      doc.text('Coach: ' + gameData.officials.coachB, 25, y);
      y += 5;
      if (gameData.officials.signatures.coachSignB) {
        doc.addImage(gameData.officials.signatures.coachSignB, 'PNG', 25, y, 50, 10);
      }
      y += 15;
    }
    
    doc.setFontSize(11);
    doc.text('Captain Signature (Before Match):', 25, y);
    y += 5;
    if (gameData.officials.signatures.captainSignB1) {
      doc.addImage(gameData.officials.signatures.captainSignB1, 'PNG', 25, y, 50, 10);
    }
    y += 15;
    
    doc.text('Captain Signature (After Match):', 25, y);
    y += 5;
    if (gameData.officials.signatures.captainSignB2) {
      doc.addImage(gameData.officials.signatures.captainSignB2, 'PNG', 25, y, 50, 10);
    }
    y += 20;
    
    // Match Officials
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(255, 193, 7);
    doc.text('MATCH OFFICIALS', 20, y);
    doc.setTextColor(0, 0, 0);
    y += 10;
    
    // Two columns for officials
    doc.setFontSize(11);
    doc.setFont(undefined, 'normal');
    
    // Left column
    var leftX = 25;
    var rightX = 110;
    var yStart = y;
    
    doc.text('1st Referee: ' + (gameData.matchInfo.ref1 || 'N/A'), leftX, y);
    y += 5;
    if (gameData.officials.signatures.firstRefSign) {
      doc.addImage(gameData.officials.signatures.firstRefSign, 'PNG', leftX, y, 40, 8);
    }
    
    y = yStart;
    doc.text('2nd Referee: ' + (gameData.matchInfo.ref2 || 'N/A'), rightX, y);
    y += 5;
    if (gameData.officials.signatures.secondRefSign) {
      doc.addImage(gameData.officials.signatures.secondRefSign, 'PNG', rightX, y, 40, 8);
    }
    
    y += 18;
    doc.text('Scorer: ' + (gameData.matchInfo.scorer || 'N/A'), leftX, y);
    y += 5;
    if (gameData.officials.signatures.scorerSign) {
      doc.addImage(gameData.officials.signatures.scorerSign, 'PNG', leftX, y, 40, 8);
    }
    
    y -= 5;
    if (gameData.matchInfo.assistScorer) {
      doc.text('Assistant Scorer: ' + gameData.matchInfo.assistScorer, rightX, y + 5);
      y += 10;
      if (gameData.officials.signatures.assistScorerSign) {
        doc.addImage(gameData.officials.signatures.assistScorerSign, 'PNG', rightX, y, 40, 8);
      }
    }
  }
  
  // Copyright footer on last page
  var pageCount = doc.internal.getNumberOfPages();
  doc.setPage(pageCount);
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.setTextColor(100, 100, 100);
  doc.text('Generated by DC_Volley ¬© 2025 - Digital Volleyball Scoresheet', 105, 285, { align: 'center' });
  
  // Save PDF
  var fileName = 'Volleyball_Match_Report_' + new Date().toISOString().split('T')[0] + '.pdf';
  doc.save(fileName);
  
  alert('PDF exported successfully!');
}

function openLineupDisplay() {
  // Save current game data to localStorage
  localStorage.setItem('volleyballGameData', JSON.stringify(gameData));
  // Open lineup display in new window
  window.open('lineup_display.html', '_blank', 'width=800,height=600');
}

function openScoreboard() {
  // Save current game data to localStorage
  localStorage.setItem('volleyballGameData', JSON.stringify(gameData));
  // Open scoreboard in new window
  window.open('scoreboard_display.html', '_blank', 'width=1200,height=800');
}

window.onload = function() {
  var today = new Date();
  document.getElementById('matchDate').value = today.toISOString().split('T')[0];
  document.getElementById('matchTime').value = today.toTimeString().substring(0, 5);
  
  initRosterTables();
  
  document.getElementById('nextLineupBtn').addEventListener('click', validateAndProceed);
  // DO NOT use addEventListener for startMatchBtn - it will be reassigned via onclick for new sets
  // document.getElementById('startMatchBtn').addEventListener('click', startMatch);
  
  // Set initial onclick for first match start
  document.getElementById('startMatchBtn').onclick = startMatch;
  
  document.getElementById('coinTossWinner').addEventListener('change', determineCoinTossOutcome);
  document.getElementById('coinTossChoice').addEventListener('change', determineCoinTossOutcome);
  
  // Team assignment auto-fill opposite side
  document.getElementById('teamAAssignment').addEventListener('change', function() {
    var teamA = this.value;
    if (teamA) {
      var teamB = teamA === 'team1' ? 'team2' : 'team1';
      document.getElementById('teamBAssignment').value = teamB;
    }
  });
  
  document.getElementById('teamBAssignment').addEventListener('change', function() {
    var teamB = this.value;
    if (teamB) {
      var teamA = teamB === 'team1' ? 'team2' : 'team1';
      document.getElementById('teamAAssignment').value = teamA;
    }
  });
  
  var positionsA = document.querySelectorAll('#courtASetup .court-setup-pos');
  positionsA.forEach(function(el) {
    var pos = parseInt(el.getAttribute('data-pos'));
    el.addEventListener('click', function() {
      assignPosition('A', pos);
    });
  });
  
  var positionsB = document.querySelectorAll('#courtBSetup .court-setup-pos');
  positionsB.forEach(function(el) {
    var pos = parseInt(el.getAttribute('data-pos'));
    el.addEventListener('click', function() {
      assignPosition('B', pos);
    });
  });
  
  console.log('DC Volleyball E-Scoresheet initialized successfully!');
};
</script>
</body>
</html>